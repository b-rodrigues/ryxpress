
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
        <meta name="description" content="Documentation for ryxpress">
      
      
      
      
        <link rel="prev" href="..">
      
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.16">
    
    
      
        <title>Reference - ryxpress</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.7e37652d.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../assets/_mkdocstrings.css">
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#reference" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

<header class="md-header" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="ryxpress" class="md-header__button md-logo" aria-label="ryxpress" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            ryxpress
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Reference
            
          </span>
        </div>
      </div>
    </div>
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
      <div class="md-header__source">
        <a href="https://github.com/b-rodrigues/ryxpress" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path fill="currentColor" d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
            
<nav class="md-tabs" aria-label="Tabs" data-md-component="tabs">
  <div class="md-grid">
    <ul class="md-tabs__list">
      
        
  
  
  
  
    <li class="md-tabs__item">
      <a href=".." class="md-tabs__link">
        
  
  
    
  
  Home

      </a>
    </li>
  

      
        
  
  
  
    
  
  
    
    
      <li class="md-tabs__item md-tabs__item--active">
        <a href="./" class="md-tabs__link">
          
  
  
  API

        </a>
      </li>
    
  

      
    </ul>
  </div>
</nav>
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    


  


<nav class="md-nav md-nav--primary md-nav--lifted" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="ryxpress" class="md-nav__button md-logo" aria-label="ryxpress" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    ryxpress
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/b-rodrigues/ryxpress" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 7.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path fill="currentColor" d="M439.6 236.1 244 40.5c-5.4-5.5-12.8-8.5-20.4-8.5s-15 3-20.4 8.4L162.5 81l51.5 51.5c27.1-9.1 52.7 16.8 43.4 43.7l49.7 49.7c34.2-11.8 61.2 31 35.5 56.7-26.5 26.5-70.2-2.9-56-37.3L240.3 199v121.9c25.3 12.5 22.3 41.8 9.1 55-6.4 6.4-15.2 10.1-24.3 10.1s-17.8-3.6-24.3-10.1c-17.6-17.6-11.1-46.9 11.2-56v-123c-20.8-8.5-24.6-30.7-18.6-45L142.6 101 8.5 235.1C3 240.6 0 247.9 0 255.5s3 15 8.5 20.4l195.6 195.7c5.4 5.4 12.7 8.4 20.4 8.4s15-3 20.4-8.4l194.7-194.7c5.4-5.4 8.4-12.8 8.4-20.4s-3-15-8.4-20.4"/></svg>
  </div>
  <div class="md-source__repository">
    GitHub
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Home
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    
    
    
    
      
        
        
      
      
    
    
    <li class="md-nav__item md-nav__item--active md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_2" checked>
        
          
          <label class="md-nav__link" for="__nav_2" id="__nav_2_label" tabindex="">
            
  
  
  <span class="md-ellipsis">
    API
    
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_2_label" aria-expanded="true">
          <label class="md-nav__title" for="__nav_2">
            <span class="md-nav__icon md-icon"></span>
            API
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    Reference
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    Reference
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#start-a-project-and-build-the-pipeline" class="md-nav__link">
    <span class="md-ellipsis">
      Start a project and build the pipeline
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ryxpress.init_proj.rxp_init" class="md-nav__link">
    <span class="md-ellipsis">
      rxp_init
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ryxpress.r_runner.rxp_make" class="md-nav__link">
    <span class="md-ellipsis">
      rxp_make
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#inspect-the-pipeline" class="md-nav__link">
    <span class="md-ellipsis">
      Inspect the pipeline
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ryxpress.inspect_logs.rxp_inspect" class="md-nav__link">
    <span class="md-ellipsis">
      rxp_inspect
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ryxpress.inspect_logs.rxp_list_logs" class="md-nav__link">
    <span class="md-ellipsis">
      rxp_list_logs
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#recover-artifacts" class="md-nav__link">
    <span class="md-ellipsis">
      Recover artifacts
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ryxpress.copy_artifacts.rxp_copy" class="md-nav__link">
    <span class="md-ellipsis">
      rxp_copy
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ryxpress.read_load.rxp_read" class="md-nav__link">
    <span class="md-ellipsis">
      rxp_read
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ryxpress.read_load.rxp_load" class="md-nav__link">
    <span class="md-ellipsis">
      rxp_load
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#visually-exploring-the-pipeline" class="md-nav__link">
    <span class="md-ellipsis">
      Visually exploring the pipeline
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ryxpress.plotting.rxp_dag_for_ci" class="md-nav__link">
    <span class="md-ellipsis">
      rxp_dag_for_ci
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ryxpress.plotting.rxp_phart" class="md-nav__link">
    <span class="md-ellipsis">
      rxp_phart
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ryxpress.tracing.rxp_trace" class="md-nav__link">
    <span class="md-ellipsis">
      rxp_trace
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#utilities" class="md-nav__link">
    <span class="md-ellipsis">
      Utilities
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ryxpress.garbage.rxp_gc" class="md-nav__link">
    <span class="md-ellipsis">
      rxp_gc
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#start-a-project-and-build-the-pipeline" class="md-nav__link">
    <span class="md-ellipsis">
      Start a project and build the pipeline
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ryxpress.init_proj.rxp_init" class="md-nav__link">
    <span class="md-ellipsis">
      rxp_init
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ryxpress.r_runner.rxp_make" class="md-nav__link">
    <span class="md-ellipsis">
      rxp_make
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#inspect-the-pipeline" class="md-nav__link">
    <span class="md-ellipsis">
      Inspect the pipeline
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ryxpress.inspect_logs.rxp_inspect" class="md-nav__link">
    <span class="md-ellipsis">
      rxp_inspect
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ryxpress.inspect_logs.rxp_list_logs" class="md-nav__link">
    <span class="md-ellipsis">
      rxp_list_logs
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#recover-artifacts" class="md-nav__link">
    <span class="md-ellipsis">
      Recover artifacts
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ryxpress.copy_artifacts.rxp_copy" class="md-nav__link">
    <span class="md-ellipsis">
      rxp_copy
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ryxpress.read_load.rxp_read" class="md-nav__link">
    <span class="md-ellipsis">
      rxp_read
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ryxpress.read_load.rxp_load" class="md-nav__link">
    <span class="md-ellipsis">
      rxp_load
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#visually-exploring-the-pipeline" class="md-nav__link">
    <span class="md-ellipsis">
      Visually exploring the pipeline
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ryxpress.plotting.rxp_dag_for_ci" class="md-nav__link">
    <span class="md-ellipsis">
      rxp_dag_for_ci
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ryxpress.plotting.rxp_phart" class="md-nav__link">
    <span class="md-ellipsis">
      rxp_phart
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ryxpress.tracing.rxp_trace" class="md-nav__link">
    <span class="md-ellipsis">
      rxp_trace
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#utilities" class="md-nav__link">
    <span class="md-ellipsis">
      Utilities
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#ryxpress.garbage.rxp_gc" class="md-nav__link">
    <span class="md-ellipsis">
      rxp_gc
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  


  
  


<h1 id="reference">Reference</h1>
<h2 id="start-a-project-and-build-the-pipeline">Start a project and build the pipeline</h2>


<div class="doc doc-object doc-function">



<a id="ryxpress.init_proj.rxp_init"></a>
    <div class="doc doc-contents first">

        <p>Initialize rixpress project files in project_path. This will generate
two R scripts: <code>gen-env.R</code>, which when executed using the rix R package
will generate a <code>default.nix</code>, which defines the pipeline's execution
environment, and <code>gen-pipeline.R</code>, which is where the pipeline is defined.
These R scripts are the same as those generated by rixpress, the R version
of this package.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>project_path</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>path to the project directory (defaults to ".")</p>
              </div>
            </td>
            <td>
                  <code>&#39;.&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>skip_prompt</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>if True, skip user confirmation prompts (defaults to False)</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>True if initialization completed (or was skipped due to non-interactive but files present),</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>False if cancelled by the user.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/ryxpress/init_proj.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">rxp_init</span><span class="p">(</span><span class="n">project_path</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;.&quot;</span><span class="p">,</span> <span class="n">skip_prompt</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="nb">bool</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Initialize rixpress project files in project_path. This will generate</span>
<span class="sd">    two R scripts: `gen-env.R`, which when executed using the rix R package</span>
<span class="sd">    will generate a `default.nix`, which defines the pipeline&#39;s execution</span>
<span class="sd">    environment, and `gen-pipeline.R`, which is where the pipeline is defined.</span>
<span class="sd">    These R scripts are the same as those generated by rixpress, the R version</span>
<span class="sd">    of this package.</span>

<span class="sd">    Args:</span>
<span class="sd">        project_path: path to the project directory (defaults to &quot;.&quot;)</span>
<span class="sd">        skip_prompt: if True, skip user confirmation prompts (defaults to False)</span>

<span class="sd">    Returns:</span>
<span class="sd">        True if initialization completed (or was skipped due to non-interactive but files present),</span>
<span class="sd">        False if cancelled by the user.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Initial confirmation before any action</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">_confirm</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Initialize project at &#39;</span><span class="si">{</span><span class="n">project_path</span><span class="si">}</span><span class="s2">&#39;?&quot;</span><span class="p">,</span> <span class="n">skip_prompt</span><span class="o">=</span><span class="n">skip_prompt</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Operation cancelled by user. No files or directories were created.&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="kc">False</span>

    <span class="n">proj</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">project_path</span><span class="p">)</span>
    <span class="c1"># Ensure project_path exists, create it if it doesn&#39;t</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">proj</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
        <span class="n">proj</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">env_file</span> <span class="o">=</span> <span class="n">proj</span> <span class="o">/</span> <span class="s2">&quot;gen-env.R&quot;</span>
    <span class="n">pipeline_file</span> <span class="o">=</span> <span class="n">proj</span> <span class="o">/</span> <span class="s2">&quot;gen-pipeline.R&quot;</span>

    <span class="n">gen_env_lines</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s2">&quot;# This script defines the default environment the pipeline runs in.&quot;</span><span class="p">,</span>
        <span class="s2">&quot;# Add the required packages to execute the code necessary for each derivation.&quot;</span><span class="p">,</span>
        <span class="s2">&quot;# If you want to create visual representations of the pipeline, consider adding&quot;</span><span class="p">,</span>
        <span class="s2">&quot;# `</span><span class="si">{visNetwork}</span><span class="s2">` and `</span><span class="si">{ggdag}</span><span class="s2">` to the list of R packages.&quot;</span><span class="p">,</span>
        <span class="s2">&quot;library(rix)&quot;</span><span class="p">,</span>
        <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="s2">&quot;# Define execution environment&quot;</span><span class="p">,</span>
        <span class="s2">&quot;rix(&quot;</span><span class="p">,</span>
        <span class="s2">&quot;  date = NULL,&quot;</span><span class="p">,</span>
        <span class="s2">&quot;  r_pkgs = NULL,&quot;</span><span class="p">,</span>
        <span class="s2">&quot;  py_conf = NULL,&quot;</span><span class="p">,</span>
        <span class="s2">&quot;  git_pkgs = list(&quot;</span><span class="p">,</span>
        <span class="s2">&quot;    </span><span class="se">\&quot;</span><span class="s2">package_name</span><span class="se">\&quot;</span><span class="s2"> = </span><span class="se">\&quot;</span><span class="s2">rixpress</span><span class="se">\&quot;</span><span class="s2">,&quot;</span><span class="p">,</span>
        <span class="s2">&quot;    </span><span class="se">\&quot;</span><span class="s2">repo_url</span><span class="se">\&quot;</span><span class="s2"> = </span><span class="se">\&quot;</span><span class="s2">https://github.com/b-rodrigues/rixpress</span><span class="se">\&quot;</span><span class="s2">,&quot;</span><span class="p">,</span>
        <span class="s2">&quot;    </span><span class="se">\&quot;</span><span class="s2">commit</span><span class="se">\&quot;</span><span class="s2"> = </span><span class="se">\&quot;</span><span class="s2">HEAD</span><span class="se">\&quot;</span><span class="s2">,&quot;</span><span class="p">,</span>
        <span class="s2">&quot;  ),&quot;</span><span class="p">,</span>
        <span class="s2">&quot;  ide = </span><span class="se">\&quot;</span><span class="s2">none</span><span class="se">\&quot;</span><span class="s2">,&quot;</span><span class="p">,</span>
        <span class="s2">&quot;  project_path = </span><span class="se">\&quot;</span><span class="s2">.</span><span class="se">\&quot;</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="s2">&quot;)&quot;</span><span class="p">,</span>
    <span class="p">]</span>

    <span class="n">gen_pipeline_lines</span> <span class="o">=</span> <span class="p">[</span>
        <span class="s2">&quot;library(rixpress)&quot;</span><span class="p">,</span>
        <span class="s2">&quot;library(igraph)&quot;</span><span class="p">,</span>
        <span class="s2">&quot;&quot;</span><span class="p">,</span>
        <span class="s2">&quot;list(&quot;</span><span class="p">,</span>
        <span class="s2">&quot;  rxp_r_file(&quot;</span><span class="p">,</span>
        <span class="s2">&quot;    name = NULL,&quot;</span><span class="p">,</span>
        <span class="s2">&quot;    path = NULL,&quot;</span><span class="p">,</span>
        <span class="s2">&quot;    read_function = </span><span class="se">\&quot;</span><span class="s2">lambda x: polars.read_csv(x, separator=&#39;|&#39;)</span><span class="se">\&quot;</span><span class="s2">&quot;</span><span class="p">,</span>
        <span class="s2">&quot;  ),&quot;</span><span class="p">,</span>
        <span class="s2">&quot;  rxp_r(&quot;</span><span class="p">,</span>
        <span class="s2">&quot;    name = NULL,&quot;</span><span class="p">,</span>
        <span class="s2">&quot;    expr = NULL&quot;</span><span class="p">,</span>
        <span class="s2">&quot;  )&quot;</span><span class="p">,</span>
        <span class="s2">&quot;) |&gt;&quot;</span><span class="p">,</span>
        <span class="s2">&quot;  rxp_populate(build = FALSE)&quot;</span><span class="p">,</span>
    <span class="p">]</span>

    <span class="c1"># Write files (overwrite if present)</span>
    <span class="n">env_file</span><span class="o">.</span><span class="n">write_text</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">gen_env_lines</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;File </span><span class="si">{</span><span class="n">env_file</span><span class="si">}</span><span class="s2"> has been written.&quot;</span><span class="p">)</span>
    <span class="n">pipeline_file</span><span class="o">.</span><span class="n">write_text</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">gen_pipeline_lines</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;File </span><span class="si">{</span><span class="n">pipeline_file</span><span class="si">}</span><span class="s2"> has been written.&quot;</span><span class="p">)</span>

    <span class="c1"># Skip Git initialization when on non-interactive sessions (CRAN/CI/test equivalent)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">_is_interactive</span><span class="p">():</span>
        <span class="nb">print</span><span class="p">(</span>
            <span class="s2">&quot;Skipping Git initialization (non-interactive session, CRAN, CI, or test environment detected).&quot;</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="kc">True</span>

    <span class="c1"># Ask whether to initialise git</span>
    <span class="k">if</span> <span class="n">_confirm</span><span class="p">(</span><span class="s2">&quot;Would you like to initialise a Git repository here?&quot;</span><span class="p">,</span> <span class="n">skip_prompt</span><span class="o">=</span><span class="n">skip_prompt</span><span class="p">):</span>
        <span class="n">git_bin</span> <span class="o">=</span> <span class="n">shutil</span><span class="o">.</span><span class="n">which</span><span class="p">(</span><span class="s2">&quot;git&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">git_bin</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span>
                <span class="s2">&quot;Git not found on PATH. Please install git and run &#39;git init&#39; manually, &quot;</span>
                <span class="s2">&quot;or initialise the repository using your preferred tool.&quot;</span>
            <span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">([</span><span class="n">git_bin</span><span class="p">,</span> <span class="s2">&quot;init&quot;</span><span class="p">],</span> <span class="n">cwd</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">proj</span><span class="p">),</span> <span class="n">check</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">)</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Git repository initialised.&quot;</span><span class="p">)</span>
            <span class="k">except</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">CalledProcessError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Failed to initialise git repository. You can run &#39;git init&#39; manually.&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Skipping Git initialization.&quot;</span><span class="p">)</span>

    <span class="k">return</span> <span class="kc">True</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">



<a id="ryxpress.r_runner.rxp_make"></a>
    <div class="doc doc-contents first">

        <p>Run the rixpress R pipeline (rxp_populate + rxp_make) by sourcing an R script.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>script</code>
            </td>
            <td>
                  <code><span title="typing.Union">Union</span>[<span title="str">str</span>, <span title="pathlib.Path">Path</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path or name of the R script to run (defaults to "gen-pipeline.R").
If a relative path is given and doesn't exist in the working directory,
this function will attempt to locate the script on PATH.</p>
              </div>
            </td>
            <td>
                  <code>&#39;gen-pipeline.R&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>verbose</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>integer passed to rixpress::rxp_make(verbose = ...)</p>
              </div>
            </td>
            <td>
                  <code>0</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>max_jobs</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>integer passed to rixpress::rxp_make(max_jobs = ...)</p>
              </div>
            </td>
            <td>
                  <code>1</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>cores</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>integer passed to rixpress::rxp_make(cores = ...)</p>
              </div>
            </td>
            <td>
                  <code>1</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>rscript_cmd</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>the Rscript binary to use (defaults to "Rscript")</p>
              </div>
            </td>
            <td>
                  <code>&#39;Rscript&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>timeout</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="int">int</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>optional timeout in seconds for the subprocess.run call</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>cwd</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="typing.Union">Union</span>[<span title="str">str</span>, <span title="pathlib.Path">Path</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>optional working directory to run Rscript in. If None, the directory
containing the provided script will be used. This is important because
pipeline.nix and related files are often imported with relative paths
(e.g. ./default.nix), so Rscript needs to be run where those files are reachable.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="ryxpress.r_runner.RRunResult">RRunResult</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>An RRunResult containing returncode, stdout, stderr.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/ryxpress/r_runner.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 34</span>
<span class="normal"> 35</span>
<span class="normal"> 36</span>
<span class="normal"> 37</span>
<span class="normal"> 38</span>
<span class="normal"> 39</span>
<span class="normal"> 40</span>
<span class="normal"> 41</span>
<span class="normal"> 42</span>
<span class="normal"> 43</span>
<span class="normal"> 44</span>
<span class="normal"> 45</span>
<span class="normal"> 46</span>
<span class="normal"> 47</span>
<span class="normal"> 48</span>
<span class="normal"> 49</span>
<span class="normal"> 50</span>
<span class="normal"> 51</span>
<span class="normal"> 52</span>
<span class="normal"> 53</span>
<span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span>
<span class="normal">111</span>
<span class="normal">112</span>
<span class="normal">113</span>
<span class="normal">114</span>
<span class="normal">115</span>
<span class="normal">116</span>
<span class="normal">117</span>
<span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">rxp_make</span><span class="p">(</span>
    <span class="n">script</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Path</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;gen-pipeline.R&quot;</span><span class="p">,</span>
    <span class="n">verbose</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">max_jobs</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
    <span class="n">cores</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
    <span class="n">rscript_cmd</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;Rscript&quot;</span><span class="p">,</span>
    <span class="n">timeout</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">int</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">cwd</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Path</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">RRunResult</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Run the rixpress R pipeline (rxp_populate + rxp_make) by sourcing an R script.</span>

<span class="sd">    Args:</span>
<span class="sd">        script: Path or name of the R script to run (defaults to &quot;gen-pipeline.R&quot;).</span>
<span class="sd">            If a relative path is given and doesn&#39;t exist in the working directory,</span>
<span class="sd">            this function will attempt to locate the script on PATH.</span>
<span class="sd">        verbose: integer passed to rixpress::rxp_make(verbose = ...)</span>
<span class="sd">        max_jobs: integer passed to rixpress::rxp_make(max_jobs = ...)</span>
<span class="sd">        cores: integer passed to rixpress::rxp_make(cores = ...)</span>
<span class="sd">        rscript_cmd: the Rscript binary to use (defaults to &quot;Rscript&quot;)</span>
<span class="sd">        timeout: optional timeout in seconds for the subprocess.run call</span>
<span class="sd">        cwd: optional working directory to run Rscript in. If None, the directory</span>
<span class="sd">            containing the provided script will be used. This is important because</span>
<span class="sd">            pipeline.nix and related files are often imported with relative paths</span>
<span class="sd">            (e.g. ./default.nix), so Rscript needs to be run where those files are reachable.</span>

<span class="sd">    Returns:</span>
<span class="sd">        An RRunResult containing returncode, stdout, stderr.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Validate integers</span>
    <span class="k">for</span> <span class="n">name</span><span class="p">,</span> <span class="n">val</span> <span class="ow">in</span> <span class="p">((</span><span class="s2">&quot;verbose&quot;</span><span class="p">,</span> <span class="n">verbose</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;max_jobs&quot;</span><span class="p">,</span> <span class="n">max_jobs</span><span class="p">),</span> <span class="p">(</span><span class="s2">&quot;cores&quot;</span><span class="p">,</span> <span class="n">cores</span><span class="p">)):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">val</span><span class="p">,</span> <span class="nb">int</span><span class="p">):</span>
            <span class="k">raise</span> <span class="ne">TypeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> must be an int, got </span><span class="si">{</span><span class="nb">type</span><span class="p">(</span><span class="n">val</span><span class="p">)</span><span class="o">.</span><span class="vm">__name__</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">val</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2"> must be &gt;= 0&quot;</span><span class="p">)</span>

    <span class="c1"># Resolve script path: prefer given path if it exists; otherwise try to find on PATH</span>
    <span class="n">script_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">script</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">script_path</span><span class="o">.</span><span class="n">is_file</span><span class="p">():</span>
        <span class="c1"># If a bare name was provided, attempt to find it on PATH</span>
        <span class="n">found</span> <span class="o">=</span> <span class="n">shutil</span><span class="o">.</span><span class="n">which</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">script</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">found</span><span class="p">:</span>
            <span class="n">script_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">found</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span>
                <span class="sa">f</span><span class="s2">&quot;R script &#39;</span><span class="si">{</span><span class="n">script</span><span class="si">}</span><span class="s2">&#39; not found in working directory and not on PATH&quot;</span>
            <span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">script_path</span> <span class="o">=</span> <span class="n">script_path</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span>

    <span class="c1"># Determine working directory for the R process:</span>
    <span class="k">if</span> <span class="n">cwd</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">run_cwd</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">cwd</span><span class="p">)</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">run_cwd</span><span class="o">.</span><span class="n">is_dir</span><span class="p">():</span>
            <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Requested cwd &#39;</span><span class="si">{</span><span class="n">cwd</span><span class="si">}</span><span class="s2">&#39; does not exist or is not a directory&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># default to the script&#39;s parent directory so relative imports (./default.nix) work</span>
        <span class="n">run_cwd</span> <span class="o">=</span> <span class="n">script_path</span><span class="o">.</span><span class="n">parent</span>

    <span class="c1"># Verify Rscript binary exists</span>
    <span class="k">if</span> <span class="n">shutil</span><span class="o">.</span><span class="n">which</span><span class="p">(</span><span class="n">rscript_cmd</span><span class="p">)</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;Rscript binary &#39;</span><span class="si">{</span><span class="n">rscript_cmd</span><span class="si">}</span><span class="s2">&#39; not found in PATH. Ensure R is installed or adjust rscript_cmd.&quot;</span>
        <span class="p">)</span>

    <span class="c1"># Prepare wrapper R script that:</span>
    <span class="c1">#  - loads rixpress,</span>
    <span class="c1">#  - sources the user&#39;s script,</span>
    <span class="c1">#  - if the sourced evaluation returns a list, calls rxp_populate on it,</span>
    <span class="c1">#  - then calls rixpress::rxp_make(...) with the provided args.</span>
    <span class="n">wrapper</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;&quot;&quot;</span>
<span class="s2">suppressPackageStartupMessages(library(rixpress))</span>

<span class="s2">script_path &lt;- &quot;</span><span class="si">{</span><span class="n">script_path</span><span class="o">.</span><span class="n">as_posix</span><span class="p">()</span><span class="si">}</span><span class="s2">&quot;</span>

<span class="s2">if (!file.exists(script_path)) </span><span class="se">{{</span>
<span class="s2">  stop(&quot;Script not found: &quot;, script_path)</span>
<span class="se">}}</span>

<span class="s2">result_value &lt;- NULL</span>

<span class="s2">res &lt;- tryCatch(</span><span class="se">{{</span>
<span class="s2">  # Source &amp; evaluate the user&#39;s script and capture the returned value (if any)</span>
<span class="s2">  result_value &lt;- eval(parse(script_path))</span>
<span class="s2">  # If the script returned a list (a pipeline), run rxp_populate on it</span>
<span class="s2">  if (!is.null(result_value) &amp;&amp; is.list(result_value)) </span><span class="se">{{</span>
<span class="s2">    pipeline &lt;- result_value</span>
<span class="s2">    pipeline &lt;- rixpress::rxp_populate(pipeline)</span>
<span class="s2">  </span><span class="se">}}</span>
<span class="s2">  # Finally, run rxp_make with the given integer parameters</span>
<span class="s2">  rixpress::rxp_make(</span>
<span class="s2">    verbose = </span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">verbose</span><span class="p">)</span><span class="si">}</span><span class="s2">,</span>
<span class="s2">    max_jobs = </span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">max_jobs</span><span class="p">)</span><span class="si">}</span><span class="s2">,</span>
<span class="s2">    cores = </span><span class="si">{</span><span class="nb">int</span><span class="p">(</span><span class="n">cores</span><span class="p">)</span><span class="si">}</span>
<span class="s2">  )</span>
<span class="se">}}</span><span class="s2">, error = function(e) </span><span class="se">{{</span>
<span class="s2">  # Print a clear error message and exit with non-zero status</span>
<span class="s2">  message(&quot;rixpress-python-runner-error: &quot;, conditionMessage(e))</span>
<span class="s2">  quit(status = 1)</span>
<span class="se">}}</span><span class="s2">)</span>

<span class="s2"># If we reach here, exit with success</span>
<span class="s2">quit(status = 0)</span>
<span class="s2">&quot;&quot;&quot;</span>

    <span class="c1"># Create temporary file for wrapper</span>
    <span class="k">with</span> <span class="n">tempfile</span><span class="o">.</span><span class="n">NamedTemporaryFile</span><span class="p">(</span><span class="n">mode</span><span class="o">=</span><span class="s2">&quot;w&quot;</span><span class="p">,</span> <span class="n">suffix</span><span class="o">=</span><span class="s2">&quot;.R&quot;</span><span class="p">,</span> <span class="n">delete</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span> <span class="k">as</span> <span class="n">tf</span><span class="p">:</span>
        <span class="n">tf</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">wrapper</span><span class="p">)</span>
        <span class="n">wrapper_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">tf</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Run Rscript on the wrapper file using the desired working directory</span>
        <span class="n">proc</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">(</span>
            <span class="p">[</span><span class="n">rscript_cmd</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">wrapper_path</span><span class="p">)],</span>
            <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
            <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span>
            <span class="n">text</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">timeout</span><span class="o">=</span><span class="n">timeout</span><span class="p">,</span>
            <span class="n">cwd</span><span class="o">=</span><span class="nb">str</span><span class="p">(</span><span class="n">run_cwd</span><span class="p">),</span>
        <span class="p">)</span>
        <span class="k">return</span> <span class="n">RRunResult</span><span class="p">(</span><span class="n">returncode</span><span class="o">=</span><span class="n">proc</span><span class="o">.</span><span class="n">returncode</span><span class="p">,</span> <span class="n">stdout</span><span class="o">=</span><span class="n">proc</span><span class="o">.</span><span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">proc</span><span class="o">.</span><span class="n">stderr</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">wrapper_path</span><span class="o">.</span><span class="n">unlink</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">pass</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div><h2 id="inspect-the-pipeline">Inspect the pipeline</h2>


<div class="doc doc-object doc-function">



<a id="ryxpress.inspect_logs.rxp_inspect"></a>
    <div class="doc doc-contents first">

        <p>Inspect the build result of a pipeline.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>project_path</code>
            </td>
            <td>
                  <code><span title="typing.Union">Union</span>[<span title="str">str</span>, <span title="pathlib.Path">Path</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>path to project root (defaults to ".")</p>
              </div>
            </td>
            <td>
                  <code>&#39;.&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>which_log</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>optional regex to select a specific log file. If None, the most recent log is used.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>pretty</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>if True, pretty-prints the result (and returns nothing).</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>as_json</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>if True, pretty prints using json.dumps(indent=2) instead of pprint.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="typing.List">List</span>[<span title="typing.Dict">Dict</span>[<span title="str">str</span>, <span title="typing.Any">Any</span>]]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A list of dict rows parsed from the selected JSON log file (unless pretty=True).</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="FileNotFoundError">FileNotFoundError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>if no logs are found or _rixpress missing.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="ValueError">ValueError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>if which_log is provided but no matching filename is found.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="RuntimeError">RuntimeError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>if the chosen log cannot be read/parsed.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/ryxpress/inspect_logs.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">rxp_inspect</span><span class="p">(</span>
    <span class="n">project_path</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Path</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;.&quot;</span><span class="p">,</span>
    <span class="n">which_log</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">pretty</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">as_json</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Any</span><span class="p">]]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Inspect the build result of a pipeline.</span>

<span class="sd">    Args:</span>
<span class="sd">        project_path: path to project root (defaults to &quot;.&quot;)</span>
<span class="sd">        which_log: optional regex to select a specific log file. If None, the most recent log is used.</span>
<span class="sd">        pretty: if True, pretty-prints the result (and returns nothing).</span>
<span class="sd">        as_json: if True, pretty prints using json.dumps(indent=2) instead of pprint.</span>

<span class="sd">    Returns:</span>
<span class="sd">        A list of dict rows parsed from the selected JSON log file (unless pretty=True).</span>

<span class="sd">    Raises:</span>
<span class="sd">        FileNotFoundError: if no logs are found or _rixpress missing.</span>
<span class="sd">        ValueError: if which_log is provided but no matching filename is found.</span>
<span class="sd">        RuntimeError: if the chosen log cannot be read/parsed.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">proj</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">project_path</span><span class="p">)</span>
    <span class="n">rixpress_dir</span> <span class="o">=</span> <span class="n">proj</span> <span class="o">/</span> <span class="s2">&quot;_rixpress&quot;</span>

    <span class="n">logs</span> <span class="o">=</span> <span class="n">rxp_list_logs</span><span class="p">(</span><span class="n">proj</span><span class="p">)</span>

    <span class="n">chosen_path</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Path</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="k">if</span> <span class="n">which_log</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">chosen_path</span> <span class="o">=</span> <span class="n">rixpress_dir</span> <span class="o">/</span> <span class="n">logs</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="s2">&quot;filename&quot;</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">re</span><span class="o">,</span><span class="w"> </span><span class="nn">logging</span>
        <span class="n">logger</span> <span class="o">=</span> <span class="n">logging</span><span class="o">.</span><span class="n">getLogger</span><span class="p">(</span><span class="vm">__name__</span><span class="p">)</span>
        <span class="n">pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="n">which_log</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">logs</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">pattern</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">entry</span><span class="p">[</span><span class="s2">&quot;filename&quot;</span><span class="p">]):</span>
                <span class="n">chosen_path</span> <span class="o">=</span> <span class="n">rixpress_dir</span> <span class="o">/</span> <span class="n">entry</span><span class="p">[</span><span class="s2">&quot;filename&quot;</span><span class="p">]</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Using log file: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">entry</span><span class="p">[</span><span class="s2">&quot;filename&quot;</span><span class="p">])</span>
                <span class="k">break</span>
        <span class="k">if</span> <span class="n">chosen_path</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No build logs found matching the pattern: </span><span class="si">{</span><span class="n">which_log</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="n">chosen_path</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="s2">&quot;r&quot;</span><span class="p">,</span> <span class="n">encoding</span><span class="o">=</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fh</span><span class="p">:</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">json</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">fh</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to read log file </span><span class="si">{</span><span class="n">chosen_path</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">rows</span> <span class="o">=</span> <span class="n">_coerce_json_to_rows</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">pretty</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">as_json</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">rows</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pprint</span><span class="p">(</span><span class="n">rows</span><span class="p">)</span>
        <span class="k">return</span>  <span class="c1"># This ensures REPL shows nothing after print, return value is None</span>

    <span class="k">return</span> <span class="n">rows</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">



<a id="ryxpress.inspect_logs.rxp_list_logs"></a>
    <div class="doc doc-contents first">

        <p>List build logs in the project's _rixpress directory.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>project_path</code>
            </td>
            <td>
                  <code><span title="typing.Union">Union</span>[<span title="str">str</span>, <span title="pathlib.Path">Path</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>path to project root (defaults to ".")</p>
              </div>
            </td>
            <td>
                  <code>&#39;.&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>pretty</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>if True, pretty-prints the result (and returns nothing).</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>as_json</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>if True, pretty prints using json.dumps(indent=2) instead of pprint.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="typing.List">List</span>[<span title="typing.Dict">Dict</span>[<span title="str">str</span>, <span title="typing.Union">Union</span>[<span title="str">str</span>, <span title="float">float</span>]]]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A list of dictionaries, each with keys:</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="typing.List">List</span>[<span title="typing.Dict">Dict</span>[<span title="str">str</span>, <span title="typing.Union">Union</span>[<span title="str">str</span>, <span title="float">float</span>]]]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <ul>
<li>filename: basename of log file (str)</li>
</ul>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="typing.List">List</span>[<span title="typing.Dict">Dict</span>[<span title="str">str</span>, <span title="typing.Union">Union</span>[<span title="str">str</span>, <span title="float">float</span>]]]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <ul>
<li>modification_time: ISO date string YYYY-MM-DD (str)</li>
</ul>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="typing.List">List</span>[<span title="typing.Dict">Dict</span>[<span title="str">str</span>, <span title="typing.Union">Union</span>[<span title="str">str</span>, <span title="float">float</span>]]]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <ul>
<li>size_kb: file size in kilobytes rounded to 2 decimals (float)</li>
</ul>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="typing.List">List</span>[<span title="typing.Dict">Dict</span>[<span title="str">str</span>, <span title="typing.Union">Union</span>[<span title="str">str</span>, <span title="float">float</span>]]]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>(unless pretty=True, in which case nothing is returned)</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="FileNotFoundError">FileNotFoundError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>if the _rixpress directory does not exist or if no logs are found.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/ryxpress/inspect_logs.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"> 54</span>
<span class="normal"> 55</span>
<span class="normal"> 56</span>
<span class="normal"> 57</span>
<span class="normal"> 58</span>
<span class="normal"> 59</span>
<span class="normal"> 60</span>
<span class="normal"> 61</span>
<span class="normal"> 62</span>
<span class="normal"> 63</span>
<span class="normal"> 64</span>
<span class="normal"> 65</span>
<span class="normal"> 66</span>
<span class="normal"> 67</span>
<span class="normal"> 68</span>
<span class="normal"> 69</span>
<span class="normal"> 70</span>
<span class="normal"> 71</span>
<span class="normal"> 72</span>
<span class="normal"> 73</span>
<span class="normal"> 74</span>
<span class="normal"> 75</span>
<span class="normal"> 76</span>
<span class="normal"> 77</span>
<span class="normal"> 78</span>
<span class="normal"> 79</span>
<span class="normal"> 80</span>
<span class="normal"> 81</span>
<span class="normal"> 82</span>
<span class="normal"> 83</span>
<span class="normal"> 84</span>
<span class="normal"> 85</span>
<span class="normal"> 86</span>
<span class="normal"> 87</span>
<span class="normal"> 88</span>
<span class="normal"> 89</span>
<span class="normal"> 90</span>
<span class="normal"> 91</span>
<span class="normal"> 92</span>
<span class="normal"> 93</span>
<span class="normal"> 94</span>
<span class="normal"> 95</span>
<span class="normal"> 96</span>
<span class="normal"> 97</span>
<span class="normal"> 98</span>
<span class="normal"> 99</span>
<span class="normal">100</span>
<span class="normal">101</span>
<span class="normal">102</span>
<span class="normal">103</span>
<span class="normal">104</span>
<span class="normal">105</span>
<span class="normal">106</span>
<span class="normal">107</span>
<span class="normal">108</span>
<span class="normal">109</span>
<span class="normal">110</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">rxp_list_logs</span><span class="p">(</span>
    <span class="n">project_path</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Path</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;.&quot;</span><span class="p">,</span>
    <span class="n">pretty</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">as_json</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Optional</span><span class="p">[</span><span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    List build logs in the project&#39;s _rixpress directory.</span>

<span class="sd">    Args:</span>
<span class="sd">        project_path: path to project root (defaults to &quot;.&quot;)</span>
<span class="sd">        pretty: if True, pretty-prints the result (and returns nothing).</span>
<span class="sd">        as_json: if True, pretty prints using json.dumps(indent=2) instead of pprint.</span>

<span class="sd">    Returns:</span>
<span class="sd">        A list of dictionaries, each with keys:</span>
<span class="sd">        - filename: basename of log file (str)</span>
<span class="sd">        - modification_time: ISO date string YYYY-MM-DD (str)</span>
<span class="sd">        - size_kb: file size in kilobytes rounded to 2 decimals (float)</span>
<span class="sd">        (unless pretty=True, in which case nothing is returned)</span>

<span class="sd">    Raises:</span>
<span class="sd">        FileNotFoundError: if the _rixpress directory does not exist or if no logs are found.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">proj</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">project_path</span><span class="p">)</span>
    <span class="n">rixpress_dir</span> <span class="o">=</span> <span class="n">proj</span> <span class="o">/</span> <span class="s2">&quot;_rixpress&quot;</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">rixpress_dir</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">rixpress_dir</span><span class="o">.</span><span class="n">is_dir</span><span class="p">():</span>
        <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="s2">&quot;_rixpress directory not found. Did you initialise the project?&quot;</span><span class="p">)</span>

    <span class="n">pattern</span> <span class="o">=</span> <span class="n">re</span><span class="o">.</span><span class="n">compile</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;^build_log.*\.json$&quot;</span><span class="p">)</span>
    <span class="n">log_files</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">rixpress_dir</span><span class="o">.</span><span class="n">iterdir</span><span class="p">()</span> <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">is_file</span><span class="p">()</span> <span class="ow">and</span> <span class="n">pattern</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="n">p</span><span class="o">.</span><span class="n">name</span><span class="p">)]</span>

    <span class="c1"># Sort by modification time (most recent first)</span>
    <span class="n">log_files</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">key</span><span class="o">=</span><span class="k">lambda</span> <span class="n">p</span><span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">stat</span><span class="p">()</span><span class="o">.</span><span class="n">st_mtime</span><span class="p">,</span> <span class="n">reverse</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">log_files</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No build logs found in </span><span class="si">{</span><span class="n">rixpress_dir</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">logs</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">float</span><span class="p">]]]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">log_files</span><span class="p">:</span>
        <span class="n">st</span> <span class="o">=</span> <span class="n">p</span><span class="o">.</span><span class="n">stat</span><span class="p">()</span>
        <span class="n">logs</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="p">{</span>
                <span class="s2">&quot;filename&quot;</span><span class="p">:</span> <span class="n">p</span><span class="o">.</span><span class="n">name</span><span class="p">,</span>
                <span class="s2">&quot;modification_time&quot;</span><span class="p">:</span> <span class="n">_iso_date_from_epoch</span><span class="p">(</span><span class="n">st</span><span class="o">.</span><span class="n">st_mtime</span><span class="p">),</span>
                <span class="s2">&quot;size_kb&quot;</span><span class="p">:</span> <span class="nb">round</span><span class="p">(</span><span class="n">st</span><span class="o">.</span><span class="n">st_size</span> <span class="o">/</span> <span class="mf">1024.0</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span>
            <span class="p">}</span>
        <span class="p">)</span>

    <span class="k">if</span> <span class="n">pretty</span><span class="p">:</span>
        <span class="k">if</span> <span class="n">as_json</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">logs</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">pprint</span><span class="p">(</span><span class="n">logs</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="k">return</span> <span class="n">logs</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div><h2 id="recover-artifacts">Recover artifacts</h2>


<div class="doc doc-object doc-function">



<a id="ryxpress.copy_artifacts.rxp_copy"></a>
    <div class="doc doc-contents first">

        <p>Copy derivations from the Nix store to ./pipeline-output.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>derivation_name</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>name of the derivation to copy (string). If None,
uses the special derivation name "all-derivations" (mirrors R).</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>dir_mode</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>octal permission string applied to copied directories (default "0755").</p>
              </div>
            </td>
            <td>
                  <code>&#39;0755&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>file_mode</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>octal permission string applied to copied files (default "0644").</p>
              </div>
            </td>
            <td>
                  <code>&#39;0644&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>project_path</code>
            </td>
            <td>
                  <code><span title="typing.Union">Union</span>[<span title="str">str</span>, <span title="pathlib.Path">Path</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>project root where _rixpress lives (defaults to ".").</p>
              </div>
            </td>
            <td>
                  <code>&#39;.&#39;</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code>None</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>None. Prints a success message upon completion.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="FileNotFoundError">FileNotFoundError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>if _rixpress or logs are missing.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="ValueError">ValueError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>on invalid modes or derivation not found.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="RuntimeError">RuntimeError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>on copy failures.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/ryxpress/copy_artifacts.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">118</span>
<span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">rxp_copy</span><span class="p">(</span>
    <span class="n">derivation_name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">dir_mode</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;0755&quot;</span><span class="p">,</span>
    <span class="n">file_mode</span><span class="p">:</span> <span class="nb">str</span> <span class="o">=</span> <span class="s2">&quot;0644&quot;</span><span class="p">,</span>
    <span class="n">project_path</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Path</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;.&quot;</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Copy derivations from the Nix store to ./pipeline-output.</span>

<span class="sd">    Args:</span>
<span class="sd">        derivation_name: name of the derivation to copy (string). If None,</span>
<span class="sd">            uses the special derivation name &quot;all-derivations&quot; (mirrors R).</span>
<span class="sd">        dir_mode: octal permission string applied to copied directories (default &quot;0755&quot;).</span>
<span class="sd">        file_mode: octal permission string applied to copied files (default &quot;0644&quot;).</span>
<span class="sd">        project_path: project root where _rixpress lives (defaults to &quot;.&quot;).</span>

<span class="sd">    Returns:</span>
<span class="sd">        None. Prints a success message upon completion.</span>

<span class="sd">    Raises:</span>
<span class="sd">        FileNotFoundError: if _rixpress or logs are missing.</span>
<span class="sd">        ValueError: on invalid modes or derivation not found.</span>
<span class="sd">        RuntimeError: on copy failures.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">project</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">project_path</span><span class="p">)</span>
    <span class="c1"># Validate modes</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">_valid_mode</span><span class="p">(</span><span class="n">dir_mode</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Invalid dir_mode: provide a character octal like &quot;0755&quot; or &quot;755&quot;.&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">_valid_mode</span><span class="p">(</span><span class="n">file_mode</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s1">&#39;Invalid file_mode: provide a character octal like &quot;0644&quot; or &quot;644&quot;.&#39;</span><span class="p">)</span>

    <span class="c1"># Ensure there is a build log</span>
    <span class="n">logs</span> <span class="o">=</span> <span class="n">rxp_list_logs</span><span class="p">(</span><span class="n">project</span><span class="p">)</span>
    <span class="c1"># rxp_list_logs raises if none; if it returned, we have log entries</span>

    <span class="c1"># Read latest build log content via rxp_inspect (most recent)</span>
    <span class="n">rows</span> <span class="o">=</span> <span class="n">rxp_inspect</span><span class="p">(</span><span class="n">project_path</span><span class="o">=</span><span class="n">project</span><span class="p">,</span> <span class="n">which_log</span><span class="o">=</span><span class="kc">None</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">rows</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">rows</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="s2">&quot;Could not read build log details; rxp_inspect returned no rows.&quot;</span><span class="p">)</span>

    <span class="c1"># Build a mapping from derivation name -&gt; list of store paths</span>
    <span class="c1"># We try to be tolerant: look for keys &#39;derivation&#39; (R), then &#39;deriv&#39;, &#39;name&#39;</span>
    <span class="n">deriv_key_candidates</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;derivation&quot;</span><span class="p">,</span> <span class="s2">&quot;deriv&quot;</span><span class="p">,</span> <span class="s2">&quot;name&quot;</span><span class="p">)</span>
    <span class="n">path_key_candidates</span> <span class="o">=</span> <span class="p">(</span><span class="s2">&quot;path&quot;</span><span class="p">,</span> <span class="s2">&quot;store_path&quot;</span><span class="p">,</span> <span class="s2">&quot;path_store&quot;</span><span class="p">,</span> <span class="s2">&quot;output_path&quot;</span><span class="p">,</span> <span class="s2">&quot;output&quot;</span><span class="p">)</span>

    <span class="n">deriv_to_paths</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">rows</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
            <span class="k">continue</span>
        <span class="n">deriv_val</span> <span class="o">=</span> <span class="n">_extract_field</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">deriv_key_candidates</span><span class="p">)</span>
        <span class="n">path_val</span> <span class="o">=</span> <span class="n">_extract_field</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="n">path_key_candidates</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">deriv_val</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># skip rows without a derivation name</span>
            <span class="k">continue</span>
        <span class="n">derivs</span> <span class="o">=</span> <span class="n">_ensure_iterable_of_strings</span><span class="p">(</span><span class="n">deriv_val</span><span class="p">)</span>
        <span class="n">paths</span> <span class="o">=</span> <span class="n">_ensure_iterable_of_strings</span><span class="p">(</span><span class="n">path_val</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">derivs</span><span class="p">:</span>
            <span class="n">deriv_to_paths</span><span class="o">.</span><span class="n">setdefault</span><span class="p">(</span><span class="n">d</span><span class="p">,</span> <span class="p">[])</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">paths</span><span class="p">)</span>

    <span class="c1"># Deduplicate path lists</span>
    <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">list</span><span class="p">(</span><span class="n">deriv_to_paths</span><span class="o">.</span><span class="n">keys</span><span class="p">()):</span>
        <span class="n">seen</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">deriv_to_paths</span><span class="p">[</span><span class="n">k</span><span class="p">]:</span>
            <span class="k">if</span> <span class="n">p</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">seen</span><span class="p">:</span>
                <span class="n">seen</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
        <span class="n">deriv_to_paths</span><span class="p">[</span><span class="n">k</span><span class="p">]</span> <span class="o">=</span> <span class="n">seen</span>

    <span class="c1"># Choose derivation_name if not provided</span>
    <span class="k">if</span> <span class="n">derivation_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">derivation_name</span> <span class="o">=</span> <span class="s2">&quot;all-derivations&quot;</span>

    <span class="k">if</span> <span class="n">derivation_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">deriv_to_paths</span><span class="p">:</span>
        <span class="c1"># Provide hint of available derivations (up to 20)</span>
        <span class="n">available</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">deriv_to_paths</span><span class="o">.</span><span class="n">keys</span><span class="p">())[:</span><span class="mi">20</span><span class="p">]</span>
        <span class="n">more</span> <span class="o">=</span> <span class="s2">&quot;, ...&quot;</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">deriv_to_paths</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">20</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;No derivation </span><span class="si">{</span><span class="n">derivation_name</span><span class="si">!r}</span><span class="s2"> found in the build log. Available: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">available</span><span class="p">)</span><span class="si">}{</span><span class="n">more</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>

    <span class="c1"># Collect paths for this derivation</span>
    <span class="n">deriv_paths</span> <span class="o">=</span> <span class="n">deriv_to_paths</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">derivation_name</span><span class="p">,</span> <span class="p">[])</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">deriv_paths</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No store paths recorded for derivation </span><span class="si">{</span><span class="n">derivation_name</span><span class="si">!r}</span><span class="s2"> in the build log.&quot;</span><span class="p">)</span>

    <span class="n">output_dir</span> <span class="o">=</span> <span class="n">_ensure_output_dir</span><span class="p">(</span><span class="n">Path</span><span class="o">.</span><span class="n">cwd</span><span class="p">())</span>

    <span class="c1"># For each store path, copy its contents into output_dir</span>
    <span class="n">copy_failed</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="n">errors</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">store_path_str</span> <span class="ow">in</span> <span class="n">deriv_paths</span><span class="p">:</span>
        <span class="n">store_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">store_path_str</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">store_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
            <span class="c1"># Skip non-existing path (warn)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Store path does not exist, skipping: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">store_path</span><span class="p">)</span>
            <span class="k">continue</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="c1"># If the derivation path is a directory, copy its children into output_dir</span>
            <span class="k">if</span> <span class="n">store_path</span><span class="o">.</span><span class="n">is_dir</span><span class="p">():</span>
                <span class="c1"># copy each child into output_dir, preserving names</span>
                <span class="k">for</span> <span class="n">child</span> <span class="ow">in</span> <span class="n">store_path</span><span class="o">.</span><span class="n">iterdir</span><span class="p">():</span>
                    <span class="n">dest</span> <span class="o">=</span> <span class="n">output_dir</span> <span class="o">/</span> <span class="n">child</span><span class="o">.</span><span class="n">name</span>
                    <span class="k">if</span> <span class="n">child</span><span class="o">.</span><span class="n">is_dir</span><span class="p">():</span>
                        <span class="c1"># Python 3.8+: dirs_exist_ok True will merge</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">shutil</span><span class="o">.</span><span class="n">copytree</span><span class="p">(</span><span class="n">child</span><span class="p">,</span> <span class="n">dest</span><span class="p">,</span> <span class="n">dirs_exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                        <span class="k">except</span> <span class="ne">TypeError</span><span class="p">:</span>
                            <span class="c1"># older Python: fallback to manual merge</span>
                            <span class="k">if</span> <span class="n">dest</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                                <span class="c1"># copy contents into existing dest</span>
                                <span class="k">for</span> <span class="n">sub</span> <span class="ow">in</span> <span class="n">child</span><span class="o">.</span><span class="n">rglob</span><span class="p">(</span><span class="s2">&quot;*&quot;</span><span class="p">):</span>
                                    <span class="n">rel</span> <span class="o">=</span> <span class="n">sub</span><span class="o">.</span><span class="n">relative_to</span><span class="p">(</span><span class="n">child</span><span class="p">)</span>
                                    <span class="n">target</span> <span class="o">=</span> <span class="n">dest</span> <span class="o">/</span> <span class="n">rel</span>
                                    <span class="k">if</span> <span class="n">sub</span><span class="o">.</span><span class="n">is_dir</span><span class="p">():</span>
                                        <span class="n">target</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                                    <span class="k">else</span><span class="p">:</span>
                                        <span class="n">target</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                                        <span class="n">shutil</span><span class="o">.</span><span class="n">copy2</span><span class="p">(</span><span class="n">sub</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>
                            <span class="k">else</span><span class="p">:</span>
                                <span class="n">shutil</span><span class="o">.</span><span class="n">copytree</span><span class="p">(</span><span class="n">child</span><span class="p">,</span> <span class="n">dest</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="c1"># file: copy, possibly overwrite</span>
                        <span class="n">shutil</span><span class="o">.</span><span class="n">copy2</span><span class="p">(</span><span class="n">child</span><span class="p">,</span> <span class="n">dest</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># store_path is a file: copy into output_dir</span>
                <span class="n">dest_file</span> <span class="o">=</span> <span class="n">output_dir</span> <span class="o">/</span> <span class="n">store_path</span><span class="o">.</span><span class="n">name</span>
                <span class="n">shutil</span><span class="o">.</span><span class="n">copy2</span><span class="p">(</span><span class="n">store_path</span><span class="p">,</span> <span class="n">dest_file</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">copy_failed</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="n">errors</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">store_path</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Copy error for </span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">store_path</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>

    <span class="c1"># Apply permissions</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">_apply_permissions</span><span class="p">(</span><span class="n">output_dir</span><span class="p">,</span> <span class="n">dir_mode</span><span class="o">=</span><span class="n">dir_mode</span><span class="p">,</span> <span class="n">file_mode</span><span class="o">=</span><span class="n">file_mode</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="c1"># Best-effort: ignore permission application errors</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Failed to apply permissions to </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">output_dir</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">copy_failed</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Copy unsuccessful: errors occurred:</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">errors</span><span class="p">))</span>

    <span class="c1"># Success message</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Copy successful, check out </span><span class="si">{</span><span class="n">output_dir</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="k">return</span> <span class="kc">None</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">



<a id="ryxpress.read_load.rxp_read"></a>
    <div class="doc doc-contents first">

        <p>Read the output of a derivation.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>derivation_name</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>name of the derivation to read.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>which_log</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>optional regex to select a specific log file. If None, the most recent log is used.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>project_path</code>
            </td>
            <td>
                  <code><span title="typing.Union">Union</span>[<span title="str">str</span>, <span title="pathlib.Path">Path</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>path to project root (defaults to ".").</p>
              </div>
            </td>
            <td>
                  <code>&#39;.&#39;</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Union">Union</span>[<span title="object">object</span>, <span title="str">str</span>, <span title="typing.List">List</span>[<span title="str">str</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The loaded object if successfully unpickled or parsed via rds2py.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Union">Union</span>[<span title="object">object</span>, <span title="str">str</span>, <span title="typing.List">List</span>[<span title="str">str</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Otherwise, returns the path string (or list of paths if multiple outputs).</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="note" open>
  <summary>Note</summary>
  <p>All failures are silent; no exceptions/warnings are raised for "can't load" cases.</p>
</details>

            <details class="quote">
              <summary>Source code in <code>src/ryxpress/read_load.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">rxp_read</span><span class="p">(</span>
    <span class="n">derivation_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">which_log</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">project_path</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Path</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;.&quot;</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="nb">object</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Read the output of a derivation.</span>

<span class="sd">    Args:</span>
<span class="sd">        derivation_name: name of the derivation to read.</span>
<span class="sd">        which_log: optional regex to select a specific log file. If None, the most recent log is used.</span>
<span class="sd">        project_path: path to project root (defaults to &quot;.&quot;).</span>

<span class="sd">    Returns:</span>
<span class="sd">        The loaded object if successfully unpickled or parsed via rds2py.</span>
<span class="sd">        Otherwise, returns the path string (or list of paths if multiple outputs).</span>

<span class="sd">    Note:</span>
<span class="sd">        All failures are silent; no exceptions/warnings are raised for &quot;can&#39;t load&quot; cases.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">resolved</span> <span class="o">=</span> <span class="n">rxp_read_load_setup</span><span class="p">(</span><span class="n">derivation_name</span><span class="p">,</span> <span class="n">which_log</span><span class="o">=</span><span class="n">which_log</span><span class="p">,</span> <span class="n">project_path</span><span class="o">=</span><span class="n">project_path</span><span class="p">)</span>

    <span class="c1"># If multiple outputs (list), return them directly</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">resolved</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">resolved</span>

    <span class="c1"># Single path (string) or fallback value (derivation_name)</span>
    <span class="n">path</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">resolved</span><span class="p">)</span>

    <span class="c1"># If path points to a directory, return it</span>
    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">path</span>

    <span class="c1"># Try to unpickle first (regardless of extension)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fh</span><span class="p">:</span>
            <span class="n">obj</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">fh</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">obj</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="c1"># Silent failure  try the next loader</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;pickle load failed for </span><span class="si">%s</span><span class="s2">; will try rds2py if available&quot;</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Try rds2py as a fallback (regardless of extension)</span>
    <span class="n">rds_obj</span> <span class="o">=</span> <span class="n">_load_rds_with_rds2py</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">rds_obj</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">rds_obj</span>

    <span class="c1"># Nothing worked; return the path string (no errors/warnings)</span>
    <span class="k">return</span> <span class="n">path</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">



<a id="ryxpress.read_load.rxp_load"></a>
    <div class="doc doc-contents first">

        <p>Load the output of a derivation into the caller's globals.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>derivation_name</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>name of the derivation to load. Also used as the variable name in globals.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>which_log</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>optional regex to select a specific log file. If None, the most recent log is used.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>project_path</code>
            </td>
            <td>
                  <code><span title="typing.Union">Union</span>[<span title="str">str</span>, <span title="pathlib.Path">Path</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>path to project root (defaults to ".").</p>
              </div>
            </td>
            <td>
                  <code>&#39;.&#39;</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Union">Union</span>[<span title="object">object</span>, <span title="str">str</span>, <span title="typing.List">List</span>[<span title="str">str</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>The loaded object if successfully unpickled or parsed.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Union">Union</span>[<span title="object">object</span>, <span title="str">str</span>, <span title="typing.List">List</span>[<span title="str">str</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Otherwise, returns the path string (or list of paths if multiple outputs).</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="note" open>
  <summary>Note</summary>
  <p>The loaded object is assigned to the caller's globals under <code>derivation_name</code>.
All failures are silent.</p>
</details>

            <details class="quote">
              <summary>Source code in <code>src/ryxpress/read_load.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">rxp_load</span><span class="p">(</span>
    <span class="n">derivation_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span>
    <span class="n">which_log</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">project_path</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Path</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;.&quot;</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Union</span><span class="p">[</span><span class="nb">object</span><span class="p">,</span> <span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Load the output of a derivation into the caller&#39;s globals.</span>

<span class="sd">    Args:</span>
<span class="sd">        derivation_name: name of the derivation to load. Also used as the variable name in globals.</span>
<span class="sd">        which_log: optional regex to select a specific log file. If None, the most recent log is used.</span>
<span class="sd">        project_path: path to project root (defaults to &quot;.&quot;).</span>

<span class="sd">    Returns:</span>
<span class="sd">        The loaded object if successfully unpickled or parsed.</span>
<span class="sd">        Otherwise, returns the path string (or list of paths if multiple outputs).</span>

<span class="sd">    Note:</span>
<span class="sd">        The loaded object is assigned to the caller&#39;s globals under `derivation_name`.</span>
<span class="sd">        All failures are silent.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">resolved</span> <span class="o">=</span> <span class="n">rxp_read_load_setup</span><span class="p">(</span><span class="n">derivation_name</span><span class="p">,</span> <span class="n">which_log</span><span class="o">=</span><span class="n">which_log</span><span class="p">,</span> <span class="n">project_path</span><span class="o">=</span><span class="n">project_path</span><span class="p">)</span>

    <span class="c1"># If multiple outputs, return them</span>
    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">resolved</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">resolved</span>

    <span class="n">path</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">resolved</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">path</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">path</span>

    <span class="c1"># Try to unpickle first</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">path</span><span class="p">,</span> <span class="s2">&quot;rb&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">fh</span><span class="p">:</span>
            <span class="n">obj</span> <span class="o">=</span> <span class="n">pickle</span><span class="o">.</span><span class="n">load</span><span class="p">(</span><span class="n">fh</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;pickle load failed for </span><span class="si">%s</span><span class="s2">; will try rds2py if available&quot;</span><span class="p">,</span> <span class="n">path</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># If pickle failed, try rds2py</span>
    <span class="k">if</span> <span class="n">obj</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">obj</span> <span class="o">=</span> <span class="n">_load_rds_with_rds2py</span><span class="p">(</span><span class="n">path</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">obj</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="c1"># Nothing we can load silently; return the path</span>
        <span class="k">return</span> <span class="n">path</span>

    <span class="c1"># Assign into caller&#39;s globals (best-effort); silence any assignment errors</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">caller_frame</span> <span class="o">=</span> <span class="n">inspect</span><span class="o">.</span><span class="n">currentframe</span><span class="p">()</span><span class="o">.</span><span class="n">f_back</span>
        <span class="k">if</span> <span class="n">caller_frame</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">caller_globals</span> <span class="o">=</span> <span class="n">caller_frame</span><span class="o">.</span><span class="n">f_globals</span>
            <span class="c1"># Use derivation_name as the variable name; keep last path component if it&#39;s a path</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">var_name</span> <span class="o">=</span> <span class="n">derivation_name</span>
                <span class="c1"># If derivation_name looks like a path, use the basename without extension</span>
                <span class="k">if</span> <span class="n">derivation_name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s2">&quot;/nix/store/&quot;</span><span class="p">)</span> <span class="ow">or</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">sep</span> <span class="ow">in</span> <span class="n">derivation_name</span><span class="p">:</span>
                    <span class="n">var_name</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">path</span><span class="p">)))[</span><span class="mi">0</span><span class="p">]</span>
                <span class="c1"># ensure valid identifier fallback</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">var_name</span><span class="o">.</span><span class="n">isidentifier</span><span class="p">():</span>
                    <span class="n">var_name</span> <span class="o">=</span> <span class="s2">&quot;_&quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">re</span><span class="o">.</span><span class="n">findall</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;\w+&quot;</span><span class="p">,</span> <span class="n">var_name</span><span class="p">))</span> <span class="ow">or</span> <span class="s2">&quot;loaded_artifact&quot;</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="n">var_name</span> <span class="o">=</span> <span class="s2">&quot;loaded_artifact&quot;</span>
            <span class="n">caller_globals</span><span class="p">[</span><span class="n">var_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">obj</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Failed to assign loaded object into caller globals&quot;</span><span class="p">,</span> <span class="n">exc_info</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">obj</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div><h2 id="visually-exploring-the-pipeline">Visually exploring the pipeline</h2>


<div class="doc doc-object doc-function">



<a id="ryxpress.plotting.rxp_dag_for_ci"></a>
    <div class="doc doc-contents first">

        <p>Build an igraph object from nodes_and_edges and write a DOT file for CI.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>nodes_and_edges</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="typing.Dict">Dict</span>[<span title="str">str</span>, <span title="typing.List">List</span>[<span title="typing.Dict">Dict</span>]]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>dict with keys 'nodes' and 'edges' as returned by
get_nodes_edges(). If None, get_nodes_edges() is called.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>output_file</code>
            </td>
            <td>
                  <code><span title="typing.Union">Union</span>[<span title="str">str</span>, <span title="pathlib.Path">Path</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>path to write DOT file. Parent directories are created as needed.</p>
              </div>
            </td>
            <td>
                  <code>&#39;_rixpress/dag.dot&#39;</code>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="ImportError">ImportError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>if python-igraph is not installed.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/ryxpress/plotting.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">119</span>
<span class="normal">120</span>
<span class="normal">121</span>
<span class="normal">122</span>
<span class="normal">123</span>
<span class="normal">124</span>
<span class="normal">125</span>
<span class="normal">126</span>
<span class="normal">127</span>
<span class="normal">128</span>
<span class="normal">129</span>
<span class="normal">130</span>
<span class="normal">131</span>
<span class="normal">132</span>
<span class="normal">133</span>
<span class="normal">134</span>
<span class="normal">135</span>
<span class="normal">136</span>
<span class="normal">137</span>
<span class="normal">138</span>
<span class="normal">139</span>
<span class="normal">140</span>
<span class="normal">141</span>
<span class="normal">142</span>
<span class="normal">143</span>
<span class="normal">144</span>
<span class="normal">145</span>
<span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">rxp_dag_for_ci</span><span class="p">(</span><span class="n">nodes_and_edges</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">]]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
                   <span class="n">output_file</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Path</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;_rixpress/dag.dot&quot;</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Build an igraph object from nodes_and_edges and write a DOT file for CI.</span>

<span class="sd">    Args:</span>
<span class="sd">        nodes_and_edges: dict with keys &#39;nodes&#39; and &#39;edges&#39; as returned by</span>
<span class="sd">            get_nodes_edges(). If None, get_nodes_edges() is called.</span>
<span class="sd">        output_file: path to write DOT file. Parent directories are created as needed.</span>

<span class="sd">    Raises:</span>
<span class="sd">        ImportError: if python-igraph is not installed.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Lazy import igraph and raise helpful error if not available</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">igraph</span>  <span class="c1"># python-igraph</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>  <span class="c1"># ImportError or other import-time errors</span>
        <span class="k">raise</span> <span class="ne">ImportError</span><span class="p">(</span>
            <span class="s2">&quot;The python &#39;igraph&#39; package is required for rxp_dag_for_ci. &quot;</span>
            <span class="s2">&quot;Install it with e.g. &#39;pip install python-igraph&#39; and try again.&quot;</span>
        <span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>

    <span class="k">if</span> <span class="n">nodes_and_edges</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">nodes_and_edges</span> <span class="o">=</span> <span class="n">get_nodes_edges</span><span class="p">()</span>

    <span class="n">edges</span> <span class="o">=</span> <span class="n">nodes_and_edges</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;edges&quot;</span><span class="p">,</span> <span class="p">[])</span>
    <span class="c1"># Build a list of tuples (from, to) for igraph</span>
    <span class="n">edge_tuples</span> <span class="o">=</span> <span class="p">[(</span><span class="n">e</span><span class="p">[</span><span class="s2">&quot;from&quot;</span><span class="p">],</span> <span class="n">e</span><span class="p">[</span><span class="s2">&quot;to&quot;</span><span class="p">])</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">edges</span><span class="p">]</span>

    <span class="c1"># Ensure output directory exists</span>
    <span class="n">out_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">output_file</span><span class="p">)</span>
    <span class="n">out_path</span><span class="o">.</span><span class="n">parent</span><span class="o">.</span><span class="n">mkdir</span><span class="p">(</span><span class="n">parents</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">exist_ok</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Create the graph from edge tuples. TupleList will create vertices named by</span>
    <span class="c1"># the unique labels encountered in the tuples.</span>
    <span class="c1"># If there are no edges but there are nodes, create an empty graph and add vertices.</span>
    <span class="k">if</span> <span class="n">edge_tuples</span><span class="p">:</span>
        <span class="n">g</span> <span class="o">=</span> <span class="n">igraph</span><span class="o">.</span><span class="n">Graph</span><span class="o">.</span><span class="n">TupleList</span><span class="p">(</span><span class="n">edge_tuples</span><span class="p">,</span> <span class="n">directed</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">vertex_name_attr</span><span class="o">=</span><span class="s2">&quot;name&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># no edges  create graph and add vertices from nodes list</span>
        <span class="n">nodes</span> <span class="o">=</span> <span class="n">nodes_and_edges</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;nodes&quot;</span><span class="p">,</span> <span class="p">[])</span>
        <span class="n">vertex_names</span> <span class="o">=</span> <span class="p">[</span><span class="n">n</span><span class="p">[</span><span class="s2">&quot;id&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">n</span> <span class="ow">in</span> <span class="n">nodes</span><span class="p">]</span>
        <span class="n">g</span> <span class="o">=</span> <span class="n">igraph</span><span class="o">.</span><span class="n">Graph</span><span class="p">(</span><span class="n">directed</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">vertex_names</span><span class="p">:</span>
            <span class="n">g</span><span class="o">.</span><span class="n">add_vertices</span><span class="p">(</span><span class="n">vertex_names</span><span class="p">)</span>
            <span class="c1"># set the &#39;name&#39; attribute automatically when vertices are named</span>

    <span class="c1"># Set vertex &#39;label&#39; attribute from vertex name</span>
    <span class="c1"># g.vs[&#39;name&#39;] should exist; copy to &#39;label&#39;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">names</span> <span class="o">=</span> <span class="n">g</span><span class="o">.</span><span class="n">vs</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>
        <span class="n">g</span><span class="o">.</span><span class="n">vs</span><span class="p">[</span><span class="s2">&quot;label&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">names</span>
        <span class="c1"># Attempt to remove the &#39;name&#39; attribute to mirror R behavior.</span>
        <span class="c1"># python-igraph allows deleting vertex attributes via &#39;del g.vs[&quot;attr&quot;]&#39;.</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">del</span> <span class="n">g</span><span class="o">.</span><span class="n">vs</span><span class="p">[</span><span class="s2">&quot;name&quot;</span><span class="p">]</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="c1"># If deletion is not supported in some igraph versions, leave it;</span>
            <span class="c1"># having both &#39;name&#39; and &#39;label&#39; is harmless for DOT output.</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Could not delete &#39;name&#39; vertex attribute; leaving it in place.&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="c1"># If the graph has no vertices or attribute access fails, continue.</span>
        <span class="k">pass</span>

    <span class="c1"># Write graph to DOT format</span>
    <span class="c1"># Use Graph.write with format=&quot;dot&quot;</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">g</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">out_path</span><span class="p">),</span> <span class="nb">format</span><span class="o">=</span><span class="s2">&quot;dot&quot;</span><span class="p">)</span>
    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">RuntimeError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Failed to write DOT file to </span><span class="si">{</span><span class="n">out_path</span><span class="si">}</span><span class="s2">: </span><span class="si">{</span><span class="n">e</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span> <span class="kn">from</span><span class="w"> </span><span class="nn">e</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">



<a id="ryxpress.plotting.rxp_phart"></a>
    <div class="doc doc-contents first">

        <p>Render a DOT graph file as an ASCII diagram using phart, showing node labels.</p>
<p>This function reads a DOT file, parses it with pydot and networkx, and
renders it in ASCII using phart. Node labels from the DOT file are used
instead of numeric node IDs.</p>


<details class="dependencies" open>
  <summary>Dependencies</summary>
  <ul>
<li>phart</li>
<li>pydot</li>
<li>networkx</li>
</ul>
</details>        <p>Make sure to add these dependencies to the execution environment to use this function.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>dot_path</code>
            </td>
            <td>
                  <code><span title="str">str</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path to the DOT file to render.</p>
              </div>
            </td>
            <td>
                <em>required</em>
            </td>
          </tr>
      </tbody>
    </table>


<p><span class="doc-section-title">Raises:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="FileNotFoundError">FileNotFoundError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If the specified DOT file does not exist.</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="ValueError">ValueError</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If the DOT file is empty or cannot be parsed into a graph.</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/ryxpress/plotting.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">rxp_phart</span><span class="p">(</span><span class="n">dot_path</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Render a DOT graph file as an ASCII diagram using phart, showing node labels.</span>

<span class="sd">    This function reads a DOT file, parses it with pydot and networkx, and</span>
<span class="sd">    renders it in ASCII using phart. Node labels from the DOT file are used</span>
<span class="sd">    instead of numeric node IDs.</span>

<span class="sd">    Dependencies:</span>
<span class="sd">        - phart</span>
<span class="sd">        - pydot</span>
<span class="sd">        - networkx</span>

<span class="sd">    Make sure to add these dependencies to the execution environment to use this function.</span>

<span class="sd">    Args:</span>
<span class="sd">        dot_path: Path to the DOT file to render.</span>

<span class="sd">    Raises:</span>
<span class="sd">        FileNotFoundError: If the specified DOT file does not exist.</span>
<span class="sd">        ValueError: If the DOT file is empty or cannot be parsed into a graph.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Dependency checks</span>
    <span class="n">missing</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">phart</span>
        <span class="kn">from</span><span class="w"> </span><span class="nn">phart</span><span class="w"> </span><span class="kn">import</span> <span class="n">ASCIIRenderer</span>
    <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
        <span class="n">missing</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;phart&quot;</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">pydot</span>
    <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
        <span class="n">missing</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;pydot&quot;</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="kn">import</span><span class="w"> </span><span class="nn">networkx</span><span class="w"> </span><span class="k">as</span><span class="w"> </span><span class="nn">nx</span>
    <span class="k">except</span> <span class="ne">ImportError</span><span class="p">:</span>
        <span class="n">missing</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="s2">&quot;networkx&quot;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">missing</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span>
            <span class="sa">f</span><span class="s2">&quot;The following dependencies are required but not installed: </span><span class="si">{</span><span class="s1">&#39;, &#39;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">missing</span><span class="p">)</span><span class="si">}</span><span class="s2">&quot;</span>
        <span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Please add them to the execution environment.&quot;</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="c1"># Check file exists</span>
    <span class="kn">import</span><span class="w"> </span><span class="nn">os</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">dot_path</span><span class="p">):</span>
        <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;DOT file not found: </span><span class="si">{</span><span class="n">dot_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># Load DOT file</span>
    <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">dot_path</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
        <span class="n">dot_data</span> <span class="o">=</span> <span class="n">f</span><span class="o">.</span><span class="n">read</span><span class="p">()</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">dot_data</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;DOT file is empty.&quot;</span><span class="p">)</span>

    <span class="c1"># Parse DOT into networkx graph</span>
    <span class="n">graphs</span> <span class="o">=</span> <span class="n">pydot</span><span class="o">.</span><span class="n">graph_from_dot_data</span><span class="p">(</span><span class="n">dot_data</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">graphs</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;No valid graphs found in DOT file.&quot;</span><span class="p">)</span>

    <span class="n">G</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">nx_pydot</span><span class="o">.</span><span class="n">from_pydot</span><span class="p">(</span><span class="n">graphs</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>

    <span class="c1"># Map node keys to labels for display</span>
    <span class="n">mapping</span> <span class="o">=</span> <span class="p">{</span><span class="n">node</span><span class="p">:</span> <span class="n">data</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;label&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">node</span><span class="p">))</span> <span class="k">for</span> <span class="n">node</span><span class="p">,</span> <span class="n">data</span> <span class="ow">in</span> <span class="n">G</span><span class="o">.</span><span class="n">nodes</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="kc">True</span><span class="p">)}</span>
    <span class="n">H</span> <span class="o">=</span> <span class="n">nx</span><span class="o">.</span><span class="n">relabel_nodes</span><span class="p">(</span><span class="n">G</span><span class="p">,</span> <span class="n">mapping</span><span class="p">)</span>

    <span class="c1"># Render ASCII</span>
    <span class="n">renderer</span> <span class="o">=</span> <span class="n">ASCIIRenderer</span><span class="p">(</span><span class="n">H</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">renderer</span><span class="o">.</span><span class="n">render</span><span class="p">())</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>

<div class="doc doc-object doc-function">



<a id="ryxpress.tracing.rxp_trace"></a>
    <div class="doc doc-contents first">

        <p>Trace lineage of derivations.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>name</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="str">str</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Name of the derivation to trace. If None, traces the whole pipeline.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>dag_file</code>
            </td>
            <td>
                  <code><span title="typing.Union">Union</span>[<span title="str">str</span>, <span title="pathlib.Path">Path</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>Path to the dag.json file (defaults to "_rixpress/dag.json").</p>
              </div>
            </td>
            <td>
                  <code><span title="pathlib.Path">Path</span>(&#39;_rixpress&#39;) / &#39;dag.json&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>transitive</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True, include transitive dependencies marked with '*'.</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>include_self</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>If True, include the node itself in dependency lists.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Dict">Dict</span>[<span title="str">str</span>, <span title="typing.Dict">Dict</span>[<span title="str">str</span>, <span title="typing.List">List</span>[<span title="str">str</span>]]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A dict mapping each inspected derivation name to a dict with keys:</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Dict">Dict</span>[<span title="str">str</span>, <span title="typing.Dict">Dict</span>[<span title="str">str</span>, <span title="typing.List">List</span>[<span title="str">str</span>]]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <ul>
<li>'dependencies' : list of dependency names (ancestors), with transitive-only names marked with '*'</li>
</ul>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Dict">Dict</span>[<span title="str">str</span>, <span title="typing.Dict">Dict</span>[<span title="str">str</span>, <span title="typing.List">List</span>[<span title="str">str</span>]]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <ul>
<li>'reverse_dependencies' : list of reverse dependents (children), with transitive-only names marked with '*'</li>
</ul>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


<details class="side-effect" open>
  <summary>Side-effect</summary>
  <p>Prints a tree representation to stdout (either the whole pipeline or
the single-node lineage).</p>
</details>

            <details class="quote">
              <summary>Source code in <code>src/ryxpress/tracing.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">146</span>
<span class="normal">147</span>
<span class="normal">148</span>
<span class="normal">149</span>
<span class="normal">150</span>
<span class="normal">151</span>
<span class="normal">152</span>
<span class="normal">153</span>
<span class="normal">154</span>
<span class="normal">155</span>
<span class="normal">156</span>
<span class="normal">157</span>
<span class="normal">158</span>
<span class="normal">159</span>
<span class="normal">160</span>
<span class="normal">161</span>
<span class="normal">162</span>
<span class="normal">163</span>
<span class="normal">164</span>
<span class="normal">165</span>
<span class="normal">166</span>
<span class="normal">167</span>
<span class="normal">168</span>
<span class="normal">169</span>
<span class="normal">170</span>
<span class="normal">171</span>
<span class="normal">172</span>
<span class="normal">173</span>
<span class="normal">174</span>
<span class="normal">175</span>
<span class="normal">176</span>
<span class="normal">177</span>
<span class="normal">178</span>
<span class="normal">179</span>
<span class="normal">180</span>
<span class="normal">181</span>
<span class="normal">182</span>
<span class="normal">183</span>
<span class="normal">184</span>
<span class="normal">185</span>
<span class="normal">186</span>
<span class="normal">187</span>
<span class="normal">188</span>
<span class="normal">189</span>
<span class="normal">190</span>
<span class="normal">191</span>
<span class="normal">192</span>
<span class="normal">193</span>
<span class="normal">194</span>
<span class="normal">195</span>
<span class="normal">196</span>
<span class="normal">197</span>
<span class="normal">198</span>
<span class="normal">199</span>
<span class="normal">200</span>
<span class="normal">201</span>
<span class="normal">202</span>
<span class="normal">203</span>
<span class="normal">204</span>
<span class="normal">205</span>
<span class="normal">206</span>
<span class="normal">207</span>
<span class="normal">208</span>
<span class="normal">209</span>
<span class="normal">210</span>
<span class="normal">211</span>
<span class="normal">212</span>
<span class="normal">213</span>
<span class="normal">214</span>
<span class="normal">215</span>
<span class="normal">216</span>
<span class="normal">217</span>
<span class="normal">218</span>
<span class="normal">219</span>
<span class="normal">220</span>
<span class="normal">221</span>
<span class="normal">222</span>
<span class="normal">223</span>
<span class="normal">224</span>
<span class="normal">225</span>
<span class="normal">226</span>
<span class="normal">227</span>
<span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">rxp_trace</span><span class="p">(</span>
    <span class="n">name</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">dag_file</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Path</span><span class="p">]</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="s2">&quot;_rixpress&quot;</span><span class="p">)</span> <span class="o">/</span> <span class="s2">&quot;dag.json&quot;</span><span class="p">,</span>
    <span class="n">transitive</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">include_self</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Trace lineage of derivations.</span>

<span class="sd">    Args:</span>
<span class="sd">        name: Name of the derivation to trace. If None, traces the whole pipeline.</span>
<span class="sd">        dag_file: Path to the dag.json file (defaults to &quot;_rixpress/dag.json&quot;).</span>
<span class="sd">        transitive: If True, include transitive dependencies marked with &#39;*&#39;.</span>
<span class="sd">        include_self: If True, include the node itself in dependency lists.</span>

<span class="sd">    Returns:</span>
<span class="sd">        A dict mapping each inspected derivation name to a dict with keys:</span>
<span class="sd">        - &#39;dependencies&#39; : list of dependency names (ancestors), with transitive-only names marked with &#39;*&#39;</span>
<span class="sd">        - &#39;reverse_dependencies&#39; : list of reverse dependents (children), with transitive-only names marked with &#39;*&#39;</span>

<span class="sd">    Side-effect:</span>
<span class="sd">        Prints a tree representation to stdout (either the whole pipeline or</span>
<span class="sd">        the single-node lineage).</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">derivs</span> <span class="o">=</span> <span class="n">_load_dag</span><span class="p">(</span><span class="n">dag_file</span><span class="p">)</span>

    <span class="n">all_names</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">derivs</span><span class="p">:</span>
        <span class="n">nm</span> <span class="o">=</span> <span class="n">_extract_name</span><span class="p">(</span><span class="n">d</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">nm</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Found derivations with missing or unparsable names in dag.json.&quot;</span><span class="p">)</span>
        <span class="n">all_names</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">nm</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">all_names</span><span class="p">:</span>
        <span class="c1"># mirror R&#39;s head(...) behaviour for listing available names</span>
        <span class="n">snippet</span> <span class="o">=</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">all_names</span><span class="p">[:</span><span class="mi">20</span><span class="p">])</span>
        <span class="n">more</span> <span class="o">=</span> <span class="s2">&quot;, ...&quot;</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">all_names</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">20</span> <span class="k">else</span> <span class="s2">&quot;&quot;</span>
        <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Derivation &#39;</span><span class="si">{</span><span class="n">name</span><span class="si">}</span><span class="s2">&#39; not found in dag.json (available: </span><span class="si">{</span><span class="n">snippet</span><span class="si">}{</span><span class="n">more</span><span class="si">}</span><span class="s2">).&quot;</span><span class="p">)</span>

    <span class="n">depends_map</span> <span class="o">=</span> <span class="n">_make_depends_map</span><span class="p">(</span><span class="n">derivs</span><span class="p">,</span> <span class="n">all_names</span><span class="p">)</span>
    <span class="n">reverse_map</span> <span class="o">=</span> <span class="n">_build_reverse_map</span><span class="p">(</span><span class="n">depends_map</span><span class="p">,</span> <span class="n">all_names</span><span class="p">)</span>

    <span class="c1"># helper to print single lineage (deps and reverse deps)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">print_single</span><span class="p">(</span><span class="n">target</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;==== Lineage for: </span><span class="si">{</span><span class="n">target</span><span class="si">}</span><span class="s2"> ====&quot;</span><span class="p">)</span>
        <span class="c1"># Dependencies (ancestors)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Dependencies (ancestors):&quot;</span><span class="p">)</span>
        <span class="n">visited</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">rec_dep</span><span class="p">(</span><span class="n">node</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">depth</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">parents</span> <span class="o">=</span> <span class="n">depends_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">node</span><span class="p">)</span> <span class="ow">or</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">parents</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">depth</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  - &lt;none&gt;&quot;</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">parents</span><span class="p">:</span>
                <span class="n">label</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">p</span><span class="si">}</span><span class="s2">*&quot;</span> <span class="k">if</span> <span class="p">(</span><span class="n">transitive</span> <span class="ow">and</span> <span class="n">depth</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">)</span> <span class="k">else</span> <span class="n">p</span>
                <span class="nb">print</span><span class="p">((</span><span class="s2">&quot;  &quot;</span> <span class="o">*</span> <span class="p">(</span><span class="n">depth</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span> <span class="o">+</span> <span class="s2">&quot;- &quot;</span> <span class="o">+</span> <span class="n">label</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">p</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">visited</span><span class="p">:</span>
                    <span class="n">visited</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">p</span><span class="p">)</span>
                    <span class="n">rec_dep</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">depth</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

        <span class="n">rec_dep</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Reverse dependencies (children):&quot;</span><span class="p">)</span>
        <span class="n">visited</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">rec_rev</span><span class="p">(</span><span class="n">node</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">depth</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">kids</span> <span class="o">=</span> <span class="n">reverse_map</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">node</span><span class="p">)</span> <span class="ow">or</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">kids</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">depth</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;  - &lt;none&gt;&quot;</span><span class="p">)</span>
                <span class="k">return</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">kids</span><span class="p">:</span>
                <span class="n">label</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">k</span><span class="si">}</span><span class="s2">*&quot;</span> <span class="k">if</span> <span class="p">(</span><span class="n">transitive</span> <span class="ow">and</span> <span class="n">depth</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">)</span> <span class="k">else</span> <span class="n">k</span>
                <span class="nb">print</span><span class="p">((</span><span class="s2">&quot;  &quot;</span> <span class="o">*</span> <span class="p">(</span><span class="n">depth</span> <span class="o">+</span> <span class="mi">1</span><span class="p">))</span> <span class="o">+</span> <span class="s2">&quot;- &quot;</span> <span class="o">+</span> <span class="n">label</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">k</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">visited</span><span class="p">:</span>
                    <span class="n">visited</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">k</span><span class="p">)</span>
                    <span class="n">rec_rev</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">depth</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

        <span class="n">rec_rev</span><span class="p">(</span><span class="n">target</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">transitive</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Note: &#39;*&#39; marks transitive dependencies (depth &gt;= 2).</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="c1"># helper to print forest starting from given roots, using depends_map (outputs -&gt; inputs)</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">print_forest_once</span><span class="p">(</span><span class="n">roots</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">],</span> <span class="n">graph</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]],</span> <span class="n">transitive_flag</span><span class="p">:</span> <span class="nb">bool</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">visited_nodes</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">rec</span><span class="p">(</span><span class="n">node</span><span class="p">:</span> <span class="nb">str</span><span class="p">,</span> <span class="n">depth</span><span class="p">:</span> <span class="nb">int</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">label</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;</span><span class="si">{</span><span class="n">node</span><span class="si">}</span><span class="s2">*&quot;</span> <span class="k">if</span> <span class="p">(</span><span class="n">transitive_flag</span> <span class="ow">and</span> <span class="n">depth</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">)</span> <span class="k">else</span> <span class="n">node</span>
            <span class="nb">print</span><span class="p">((</span><span class="s2">&quot;  &quot;</span> <span class="o">*</span> <span class="n">depth</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;- &quot;</span> <span class="o">+</span> <span class="n">label</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">node</span> <span class="ow">in</span> <span class="n">visited_nodes</span><span class="p">:</span>
                <span class="k">return</span>
            <span class="n">visited_nodes</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">node</span><span class="p">)</span>
            <span class="n">kids</span> <span class="o">=</span> <span class="n">graph</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">node</span><span class="p">)</span> <span class="ow">or</span> <span class="p">[]</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">kids</span><span class="p">:</span>
                <span class="k">return</span>
            <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="n">kids</span><span class="p">:</span>
                <span class="n">rec</span><span class="p">(</span><span class="n">k</span><span class="p">,</span> <span class="n">depth</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">roots</span><span class="p">:</span>
            <span class="n">rec</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>

    <span class="c1"># sinks: nodes with no children in reverse_map</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">sinks</span><span class="p">()</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
        <span class="n">no_children</span> <span class="o">=</span> <span class="p">[</span><span class="n">n</span> <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">kids</span> <span class="ow">in</span> <span class="n">reverse_map</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">kids</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">no_children</span><span class="p">:</span>
            <span class="k">return</span> <span class="n">no_children</span>
        <span class="n">outdeg_vals</span> <span class="o">=</span> <span class="p">{</span><span class="n">n</span><span class="p">:</span> <span class="nb">len</span><span class="p">(</span><span class="n">kids</span><span class="p">)</span> <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">kids</span> <span class="ow">in</span> <span class="n">reverse_map</span><span class="o">.</span><span class="n">items</span><span class="p">()}</span>
        <span class="k">if</span> <span class="n">outdeg_vals</span><span class="p">:</span>
            <span class="n">min_outdeg</span> <span class="o">=</span> <span class="nb">min</span><span class="p">(</span><span class="n">outdeg_vals</span><span class="o">.</span><span class="n">values</span><span class="p">())</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">n</span> <span class="k">for</span> <span class="n">n</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">outdeg_vals</span><span class="o">.</span><span class="n">items</span><span class="p">()</span> <span class="k">if</span> <span class="n">v</span> <span class="o">==</span> <span class="n">min_outdeg</span><span class="p">]</span>
        <span class="k">return</span> <span class="p">[]</span>

    <span class="c1"># Build results mapping</span>
    <span class="n">results</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]]</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="k">for</span> <span class="n">nm</span> <span class="ow">in</span> <span class="n">all_names</span><span class="p">:</span>
        <span class="n">deps</span> <span class="o">=</span> <span class="n">_marked_vec</span><span class="p">(</span><span class="n">nm</span><span class="p">,</span> <span class="n">depends_map</span><span class="p">,</span> <span class="n">transitive</span><span class="p">)</span>
        <span class="n">rdeps</span> <span class="o">=</span> <span class="n">_marked_vec</span><span class="p">(</span><span class="n">nm</span><span class="p">,</span> <span class="n">reverse_map</span><span class="p">,</span> <span class="n">transitive</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">include_self</span><span class="p">:</span>
            <span class="n">deps</span> <span class="o">=</span> <span class="n">_unique_preserve_order</span><span class="p">([</span><span class="n">nm</span><span class="p">]</span> <span class="o">+</span> <span class="n">deps</span><span class="p">)</span>
            <span class="n">rdeps</span> <span class="o">=</span> <span class="n">_unique_preserve_order</span><span class="p">([</span><span class="n">nm</span><span class="p">]</span> <span class="o">+</span> <span class="n">rdeps</span><span class="p">)</span>
        <span class="n">results</span><span class="p">[</span><span class="n">nm</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;dependencies&quot;</span><span class="p">:</span> <span class="n">deps</span><span class="p">,</span> <span class="s2">&quot;reverse_dependencies&quot;</span><span class="p">:</span> <span class="n">rdeps</span><span class="p">}</span>

    <span class="k">if</span> <span class="n">name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;==== Pipeline dependency tree (outputs </span><span class="se">\u2192</span><span class="s2"> inputs) ====&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">root</span> <span class="ow">in</span> <span class="n">sinks</span><span class="p">():</span>
            <span class="n">print_forest_once</span><span class="p">([</span><span class="n">root</span><span class="p">],</span> <span class="n">depends_map</span><span class="p">,</span> <span class="n">transitive</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">transitive</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Note: &#39;*&#39; marks transitive dependencies (depth &gt;= 2).</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">results</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">print_single</span><span class="p">(</span><span class="n">name</span><span class="p">)</span>
        <span class="c1"># return only the single-name mapping to match the R invisible(results[name]) behaviour</span>
        <span class="k">return</span> <span class="p">{</span><span class="n">name</span><span class="p">:</span> <span class="n">results</span><span class="p">[</span><span class="n">name</span><span class="p">]}</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div><h2 id="utilities">Utilities</h2>


<div class="doc doc-object doc-function">



<a id="ryxpress.garbage.rxp_gc"></a>
    <div class="doc doc-contents first">

        <p>Garbage collect Nix store paths and build logs produced by rixpress.</p>


<p><span class="doc-section-title">Parameters:</span></p>
    <table>
      <thead>
        <tr>
          <th>Name</th>
          <th>Type</th>
          <th>Description</th>
          <th>Default</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                <code>keep_since</code>
            </td>
            <td>
                  <code><span title="typing.Optional">Optional</span>[<span title="typing.Union">Union</span>[<span title="str">str</span>, <span title="datetime.date">date</span>]]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>None for full GC, or a date/ISO date string (YYYY-MM-DD) to keep logs newer-or-equal to that date.</p>
              </div>
            </td>
            <td>
                  <code>None</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>project_path</code>
            </td>
            <td>
                  <code><span title="typing.Union">Union</span>[<span title="str">str</span>, <span title="pathlib.Path">Path</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>project root containing _rixpress</p>
              </div>
            </td>
            <td>
                  <code>&#39;.&#39;</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>dry_run</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>if True, show what would be deleted without deleting</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>timeout_sec</code>
            </td>
            <td>
                  <code><span title="int">int</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>timeout for invoked nix-store commands and for lock staleness checks</p>
              </div>
            </td>
            <td>
                  <code>300</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>verbose</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>if True, print extra diagnostic output</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>ask</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>if True, prompt for confirmation before destructive operations (default True)</p>
              </div>
            </td>
            <td>
                  <code>True</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>pretty</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>if True, pretty-prints the result (and returns nothing).</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                <code>as_json</code>
            </td>
            <td>
                  <code><span title="bool">bool</span></code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>if True, pretty prints using json.dumps(indent=2) instead of pprint.</p>
              </div>
            </td>
            <td>
                  <code>False</code>
            </td>
          </tr>
      </tbody>
    </table>


    <p><span class="doc-section-title">Returns:</span></p>
    <table>
      <thead>
        <tr>
          <th>Type</th>
          <th>Description</th>
        </tr>
      </thead>
      <tbody>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Dict">Dict</span>[<span title="str">str</span>, <span title="object">object</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>A summary dict with canonical keys:</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Dict">Dict</span>[<span title="str">str</span>, <span title="object">object</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>kept, deleted, protected, deleted_count, failed_count, referenced_count,</p>
              </div>
            </td>
          </tr>
          <tr class="doc-section-item">
            <td>
                  <code><span title="typing.Dict">Dict</span>[<span title="str">str</span>, <span title="object">object</span>]</code>
            </td>
            <td>
              <div class="doc-md-description">
                <p>log_files_deleted, log_files_failed, dry_run_details</p>
              </div>
            </td>
          </tr>
      </tbody>
    </table>


            <details class="quote">
              <summary>Source code in <code>src/ryxpress/garbage.py</code></summary>
              <div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal">228</span>
<span class="normal">229</span>
<span class="normal">230</span>
<span class="normal">231</span>
<span class="normal">232</span>
<span class="normal">233</span>
<span class="normal">234</span>
<span class="normal">235</span>
<span class="normal">236</span>
<span class="normal">237</span>
<span class="normal">238</span>
<span class="normal">239</span>
<span class="normal">240</span>
<span class="normal">241</span>
<span class="normal">242</span>
<span class="normal">243</span>
<span class="normal">244</span>
<span class="normal">245</span>
<span class="normal">246</span>
<span class="normal">247</span>
<span class="normal">248</span>
<span class="normal">249</span>
<span class="normal">250</span>
<span class="normal">251</span>
<span class="normal">252</span>
<span class="normal">253</span>
<span class="normal">254</span>
<span class="normal">255</span>
<span class="normal">256</span>
<span class="normal">257</span>
<span class="normal">258</span>
<span class="normal">259</span>
<span class="normal">260</span>
<span class="normal">261</span>
<span class="normal">262</span>
<span class="normal">263</span>
<span class="normal">264</span>
<span class="normal">265</span>
<span class="normal">266</span>
<span class="normal">267</span>
<span class="normal">268</span>
<span class="normal">269</span>
<span class="normal">270</span>
<span class="normal">271</span>
<span class="normal">272</span>
<span class="normal">273</span>
<span class="normal">274</span>
<span class="normal">275</span>
<span class="normal">276</span>
<span class="normal">277</span>
<span class="normal">278</span>
<span class="normal">279</span>
<span class="normal">280</span>
<span class="normal">281</span>
<span class="normal">282</span>
<span class="normal">283</span>
<span class="normal">284</span>
<span class="normal">285</span>
<span class="normal">286</span>
<span class="normal">287</span>
<span class="normal">288</span>
<span class="normal">289</span>
<span class="normal">290</span>
<span class="normal">291</span>
<span class="normal">292</span>
<span class="normal">293</span>
<span class="normal">294</span>
<span class="normal">295</span>
<span class="normal">296</span>
<span class="normal">297</span>
<span class="normal">298</span>
<span class="normal">299</span>
<span class="normal">300</span>
<span class="normal">301</span>
<span class="normal">302</span>
<span class="normal">303</span>
<span class="normal">304</span>
<span class="normal">305</span>
<span class="normal">306</span>
<span class="normal">307</span>
<span class="normal">308</span>
<span class="normal">309</span>
<span class="normal">310</span>
<span class="normal">311</span>
<span class="normal">312</span>
<span class="normal">313</span>
<span class="normal">314</span>
<span class="normal">315</span>
<span class="normal">316</span>
<span class="normal">317</span>
<span class="normal">318</span>
<span class="normal">319</span>
<span class="normal">320</span>
<span class="normal">321</span>
<span class="normal">322</span>
<span class="normal">323</span>
<span class="normal">324</span>
<span class="normal">325</span>
<span class="normal">326</span>
<span class="normal">327</span>
<span class="normal">328</span>
<span class="normal">329</span>
<span class="normal">330</span>
<span class="normal">331</span>
<span class="normal">332</span>
<span class="normal">333</span>
<span class="normal">334</span>
<span class="normal">335</span>
<span class="normal">336</span>
<span class="normal">337</span>
<span class="normal">338</span>
<span class="normal">339</span>
<span class="normal">340</span>
<span class="normal">341</span>
<span class="normal">342</span>
<span class="normal">343</span>
<span class="normal">344</span>
<span class="normal">345</span>
<span class="normal">346</span>
<span class="normal">347</span>
<span class="normal">348</span>
<span class="normal">349</span>
<span class="normal">350</span>
<span class="normal">351</span>
<span class="normal">352</span>
<span class="normal">353</span>
<span class="normal">354</span>
<span class="normal">355</span>
<span class="normal">356</span>
<span class="normal">357</span>
<span class="normal">358</span>
<span class="normal">359</span>
<span class="normal">360</span>
<span class="normal">361</span>
<span class="normal">362</span>
<span class="normal">363</span>
<span class="normal">364</span>
<span class="normal">365</span>
<span class="normal">366</span>
<span class="normal">367</span>
<span class="normal">368</span>
<span class="normal">369</span>
<span class="normal">370</span>
<span class="normal">371</span>
<span class="normal">372</span>
<span class="normal">373</span>
<span class="normal">374</span>
<span class="normal">375</span>
<span class="normal">376</span>
<span class="normal">377</span>
<span class="normal">378</span>
<span class="normal">379</span>
<span class="normal">380</span>
<span class="normal">381</span>
<span class="normal">382</span>
<span class="normal">383</span>
<span class="normal">384</span>
<span class="normal">385</span>
<span class="normal">386</span>
<span class="normal">387</span>
<span class="normal">388</span>
<span class="normal">389</span>
<span class="normal">390</span>
<span class="normal">391</span>
<span class="normal">392</span>
<span class="normal">393</span>
<span class="normal">394</span>
<span class="normal">395</span>
<span class="normal">396</span>
<span class="normal">397</span>
<span class="normal">398</span>
<span class="normal">399</span>
<span class="normal">400</span>
<span class="normal">401</span>
<span class="normal">402</span>
<span class="normal">403</span>
<span class="normal">404</span>
<span class="normal">405</span>
<span class="normal">406</span>
<span class="normal">407</span>
<span class="normal">408</span>
<span class="normal">409</span>
<span class="normal">410</span>
<span class="normal">411</span>
<span class="normal">412</span>
<span class="normal">413</span>
<span class="normal">414</span>
<span class="normal">415</span>
<span class="normal">416</span>
<span class="normal">417</span>
<span class="normal">418</span>
<span class="normal">419</span>
<span class="normal">420</span>
<span class="normal">421</span>
<span class="normal">422</span>
<span class="normal">423</span>
<span class="normal">424</span>
<span class="normal">425</span>
<span class="normal">426</span>
<span class="normal">427</span>
<span class="normal">428</span>
<span class="normal">429</span>
<span class="normal">430</span>
<span class="normal">431</span>
<span class="normal">432</span>
<span class="normal">433</span>
<span class="normal">434</span>
<span class="normal">435</span>
<span class="normal">436</span>
<span class="normal">437</span>
<span class="normal">438</span>
<span class="normal">439</span>
<span class="normal">440</span>
<span class="normal">441</span>
<span class="normal">442</span>
<span class="normal">443</span>
<span class="normal">444</span>
<span class="normal">445</span>
<span class="normal">446</span>
<span class="normal">447</span>
<span class="normal">448</span>
<span class="normal">449</span>
<span class="normal">450</span>
<span class="normal">451</span>
<span class="normal">452</span>
<span class="normal">453</span>
<span class="normal">454</span>
<span class="normal">455</span>
<span class="normal">456</span>
<span class="normal">457</span>
<span class="normal">458</span>
<span class="normal">459</span>
<span class="normal">460</span>
<span class="normal">461</span>
<span class="normal">462</span>
<span class="normal">463</span>
<span class="normal">464</span>
<span class="normal">465</span>
<span class="normal">466</span>
<span class="normal">467</span>
<span class="normal">468</span>
<span class="normal">469</span>
<span class="normal">470</span>
<span class="normal">471</span>
<span class="normal">472</span>
<span class="normal">473</span>
<span class="normal">474</span>
<span class="normal">475</span>
<span class="normal">476</span>
<span class="normal">477</span>
<span class="normal">478</span>
<span class="normal">479</span>
<span class="normal">480</span>
<span class="normal">481</span>
<span class="normal">482</span>
<span class="normal">483</span>
<span class="normal">484</span>
<span class="normal">485</span>
<span class="normal">486</span>
<span class="normal">487</span>
<span class="normal">488</span>
<span class="normal">489</span>
<span class="normal">490</span>
<span class="normal">491</span>
<span class="normal">492</span>
<span class="normal">493</span>
<span class="normal">494</span>
<span class="normal">495</span>
<span class="normal">496</span>
<span class="normal">497</span>
<span class="normal">498</span>
<span class="normal">499</span>
<span class="normal">500</span>
<span class="normal">501</span>
<span class="normal">502</span>
<span class="normal">503</span>
<span class="normal">504</span>
<span class="normal">505</span>
<span class="normal">506</span>
<span class="normal">507</span>
<span class="normal">508</span>
<span class="normal">509</span>
<span class="normal">510</span>
<span class="normal">511</span>
<span class="normal">512</span>
<span class="normal">513</span>
<span class="normal">514</span>
<span class="normal">515</span>
<span class="normal">516</span>
<span class="normal">517</span>
<span class="normal">518</span>
<span class="normal">519</span>
<span class="normal">520</span>
<span class="normal">521</span>
<span class="normal">522</span>
<span class="normal">523</span>
<span class="normal">524</span>
<span class="normal">525</span>
<span class="normal">526</span>
<span class="normal">527</span>
<span class="normal">528</span>
<span class="normal">529</span>
<span class="normal">530</span>
<span class="normal">531</span>
<span class="normal">532</span>
<span class="normal">533</span>
<span class="normal">534</span>
<span class="normal">535</span>
<span class="normal">536</span>
<span class="normal">537</span>
<span class="normal">538</span>
<span class="normal">539</span>
<span class="normal">540</span>
<span class="normal">541</span>
<span class="normal">542</span>
<span class="normal">543</span>
<span class="normal">544</span>
<span class="normal">545</span>
<span class="normal">546</span>
<span class="normal">547</span>
<span class="normal">548</span>
<span class="normal">549</span>
<span class="normal">550</span>
<span class="normal">551</span>
<span class="normal">552</span>
<span class="normal">553</span>
<span class="normal">554</span>
<span class="normal">555</span>
<span class="normal">556</span>
<span class="normal">557</span>
<span class="normal">558</span>
<span class="normal">559</span>
<span class="normal">560</span>
<span class="normal">561</span>
<span class="normal">562</span>
<span class="normal">563</span>
<span class="normal">564</span>
<span class="normal">565</span>
<span class="normal">566</span>
<span class="normal">567</span>
<span class="normal">568</span>
<span class="normal">569</span>
<span class="normal">570</span>
<span class="normal">571</span>
<span class="normal">572</span>
<span class="normal">573</span>
<span class="normal">574</span>
<span class="normal">575</span>
<span class="normal">576</span>
<span class="normal">577</span>
<span class="normal">578</span>
<span class="normal">579</span>
<span class="normal">580</span>
<span class="normal">581</span>
<span class="normal">582</span>
<span class="normal">583</span>
<span class="normal">584</span>
<span class="normal">585</span>
<span class="normal">586</span>
<span class="normal">587</span>
<span class="normal">588</span>
<span class="normal">589</span>
<span class="normal">590</span>
<span class="normal">591</span>
<span class="normal">592</span>
<span class="normal">593</span>
<span class="normal">594</span>
<span class="normal">595</span>
<span class="normal">596</span>
<span class="normal">597</span>
<span class="normal">598</span>
<span class="normal">599</span>
<span class="normal">600</span>
<span class="normal">601</span>
<span class="normal">602</span>
<span class="normal">603</span>
<span class="normal">604</span>
<span class="normal">605</span>
<span class="normal">606</span>
<span class="normal">607</span>
<span class="normal">608</span>
<span class="normal">609</span>
<span class="normal">610</span>
<span class="normal">611</span>
<span class="normal">612</span>
<span class="normal">613</span>
<span class="normal">614</span>
<span class="normal">615</span>
<span class="normal">616</span>
<span class="normal">617</span>
<span class="normal">618</span>
<span class="normal">619</span>
<span class="normal">620</span>
<span class="normal">621</span>
<span class="normal">622</span>
<span class="normal">623</span>
<span class="normal">624</span>
<span class="normal">625</span>
<span class="normal">626</span>
<span class="normal">627</span>
<span class="normal">628</span>
<span class="normal">629</span>
<span class="normal">630</span>
<span class="normal">631</span>
<span class="normal">632</span>
<span class="normal">633</span>
<span class="normal">634</span>
<span class="normal">635</span>
<span class="normal">636</span>
<span class="normal">637</span>
<span class="normal">638</span>
<span class="normal">639</span>
<span class="normal">640</span>
<span class="normal">641</span>
<span class="normal">642</span>
<span class="normal">643</span>
<span class="normal">644</span>
<span class="normal">645</span>
<span class="normal">646</span>
<span class="normal">647</span>
<span class="normal">648</span>
<span class="normal">649</span>
<span class="normal">650</span>
<span class="normal">651</span>
<span class="normal">652</span>
<span class="normal">653</span>
<span class="normal">654</span>
<span class="normal">655</span>
<span class="normal">656</span>
<span class="normal">657</span>
<span class="normal">658</span></pre></div></td><td class="code"><div><pre><span></span><code><span class="k">def</span><span class="w"> </span><span class="nf">rxp_gc</span><span class="p">(</span>
    <span class="n">keep_since</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">date</span><span class="p">]]</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">project_path</span><span class="p">:</span> <span class="n">Union</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Path</span><span class="p">]</span> <span class="o">=</span> <span class="s2">&quot;.&quot;</span><span class="p">,</span>
    <span class="n">dry_run</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">timeout_sec</span><span class="p">:</span> <span class="nb">int</span> <span class="o">=</span> <span class="mi">300</span><span class="p">,</span>
    <span class="n">verbose</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">ask</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">True</span><span class="p">,</span>
    <span class="n">pretty</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
    <span class="n">as_json</span><span class="p">:</span> <span class="nb">bool</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>
<span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">object</span><span class="p">]:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Garbage collect Nix store paths and build logs produced by rixpress.</span>

<span class="sd">    Args:</span>
<span class="sd">        keep_since: None for full GC, or a date/ISO date string (YYYY-MM-DD) to keep logs newer-or-equal to that date.</span>
<span class="sd">        project_path: project root containing _rixpress</span>
<span class="sd">        dry_run: if True, show what would be deleted without deleting</span>
<span class="sd">        timeout_sec: timeout for invoked nix-store commands and for lock staleness checks</span>
<span class="sd">        verbose: if True, print extra diagnostic output</span>
<span class="sd">        ask: if True, prompt for confirmation before destructive operations (default True)</span>
<span class="sd">        pretty: if True, pretty-prints the result (and returns nothing).</span>
<span class="sd">        as_json: if True, pretty prints using json.dumps(indent=2) instead of pprint.</span>

<span class="sd">    Returns:</span>
<span class="sd">        A summary dict with canonical keys:</span>
<span class="sd">        kept, deleted, protected, deleted_count, failed_count, referenced_count,</span>
<span class="sd">        log_files_deleted, log_files_failed, dry_run_details</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">nix_bin</span> <span class="o">=</span> <span class="n">shutil</span><span class="o">.</span><span class="n">which</span><span class="p">(</span><span class="s2">&quot;nix-store&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">nix_bin</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="s2">&quot;nix-store not found on PATH. Install Nix or adjust PATH.&quot;</span><span class="p">)</span>

    <span class="n">project_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">project_path</span><span class="p">)</span><span class="o">.</span><span class="n">resolve</span><span class="p">()</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">project_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
        <span class="k">raise</span> <span class="ne">FileNotFoundError</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;Project path does not exist: </span><span class="si">{</span><span class="n">project_path</span><span class="si">}</span><span class="s2">&quot;</span><span class="p">)</span>

    <span class="n">lock_file_path</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">tempfile</span><span class="o">.</span><span class="n">gettempdir</span><span class="p">())</span> <span class="o">/</span> <span class="s2">&quot;rixpress_gc.lock&quot;</span>

    <span class="c1"># record of temp gcroot symlink paths we created so we can remove them later</span>
    <span class="n">created_gcroot_links</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="n">Path</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

    <span class="c1"># ensure we cleanup on signals</span>
    <span class="k">def</span><span class="w"> </span><span class="nf">_cleanup_on_signal</span><span class="p">(</span><span class="n">signum</span><span class="p">,</span> <span class="n">frame</span><span class="p">):</span>
        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Received signal </span><span class="si">%s</span><span class="s2">, cleaning up...&quot;</span><span class="p">,</span> <span class="n">signum</span><span class="p">)</span>
        <span class="c1"># remove any gcroot links</span>
        <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">created_gcroot_links</span><span class="p">:</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                    <span class="n">p</span><span class="o">.</span><span class="n">unlink</span><span class="p">()</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="k">pass</span>
        <span class="c1"># remove lock file if held</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">lock_path_context</span> <span class="ow">and</span> <span class="n">lock_path_context</span><span class="o">.</span><span class="n">acquired</span><span class="p">:</span>
                <span class="n">lock_path_context</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">raise</span> <span class="ne">SystemExit</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># placeholder for context so signal handler can access</span>
    <span class="n">lock_path_context</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">LockFile</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

    <span class="c1"># Register handlers</span>
    <span class="n">old_sigint</span> <span class="o">=</span> <span class="n">signal</span><span class="o">.</span><span class="n">getsignal</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGINT</span><span class="p">)</span>
    <span class="n">old_sigterm</span> <span class="o">=</span> <span class="n">signal</span><span class="o">.</span><span class="n">getsignal</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGTERM</span><span class="p">)</span>
    <span class="n">signal</span><span class="o">.</span><span class="n">signal</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGINT</span><span class="p">,</span> <span class="n">_cleanup_on_signal</span><span class="p">)</span>
    <span class="n">signal</span><span class="o">.</span><span class="n">signal</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGTERM</span><span class="p">,</span> <span class="n">_cleanup_on_signal</span><span class="p">)</span>

    <span class="k">try</span><span class="p">:</span>
        <span class="c1"># Acquire lock with context manager (atomic)</span>
        <span class="n">lock_path_context</span> <span class="o">=</span> <span class="n">LockFile</span><span class="p">(</span><span class="n">lock_file_path</span><span class="p">,</span> <span class="n">timeout_sec</span><span class="o">=</span><span class="n">timeout_sec</span><span class="p">)</span>
        <span class="n">lock_path_context</span><span class="o">.</span><span class="n">acquire</span><span class="p">()</span>

        <span class="c1"># parse keep_since</span>
        <span class="k">if</span> <span class="n">keep_since</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">keep_since</span><span class="p">,</span> <span class="n">date</span><span class="p">)</span> <span class="ow">and</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">keep_since</span><span class="p">,</span> <span class="n">datetime</span><span class="p">):</span>
                <span class="n">keep_date</span> <span class="o">=</span> <span class="n">keep_since</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="c1"># accept YYYY-MM-DD string</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">keep_date</span> <span class="o">=</span> <span class="n">_parse_iso_date</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">keep_since</span><span class="p">))</span>
                <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span><span class="p">(</span><span class="s2">&quot;Invalid &#39;keep_since&#39;. Use a date or &#39;YYYY-MM-DD&#39; string.&quot;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">keep_date</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="c1"># Gather logs</span>
        <span class="n">all_logs</span> <span class="o">=</span> <span class="n">rxp_list_logs</span><span class="p">(</span><span class="n">project_path</span><span class="p">)</span>
        <span class="c1"># Expect list of dicts with &#39;filename&#39; and &#39;modification_time&#39;</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">all_logs</span><span class="p">,</span> <span class="nb">list</span><span class="p">)</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">all_logs</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;No build logs found. Nothing to do.&quot;</span><span class="p">)</span>
            <span class="c1"># canonical empty summary</span>
            <span class="k">return</span> <span class="p">{</span>
                <span class="s2">&quot;kept&quot;</span><span class="p">:</span> <span class="p">[],</span>
                <span class="s2">&quot;deleted&quot;</span><span class="p">:</span> <span class="p">[],</span>
                <span class="s2">&quot;protected&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                <span class="s2">&quot;deleted_count&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                <span class="s2">&quot;failed_count&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                <span class="s2">&quot;referenced_count&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                <span class="s2">&quot;log_files_deleted&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                <span class="s2">&quot;log_files_failed&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
                <span class="s2">&quot;dry_run_details&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
            <span class="p">}</span>

        <span class="c1"># Partition logs</span>
        <span class="n">logs_to_keep</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="n">logs_to_delete</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">entry</span> <span class="ow">in</span> <span class="n">all_logs</span><span class="p">:</span>
            <span class="n">fn</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;filename&quot;</span><span class="p">)</span>
            <span class="n">mtime</span> <span class="o">=</span> <span class="n">entry</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;modification_time&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">fn</span> <span class="ow">or</span> <span class="ow">not</span> <span class="n">mtime</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">mdate</span> <span class="o">=</span> <span class="n">_parse_iso_date</span><span class="p">(</span><span class="n">mtime</span><span class="p">)</span>
            <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                <span class="c1"># If malformed, treat as older than keep_since to be conservative</span>
                <span class="n">mdate</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">min</span><span class="o">.</span><span class="n">date</span><span class="p">()</span>
            <span class="k">if</span> <span class="n">keep_date</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">logs_to_keep</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">entry</span><span class="p">)</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">mdate</span> <span class="o">&gt;=</span> <span class="n">keep_date</span><span class="p">:</span>
                    <span class="n">logs_to_keep</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">entry</span><span class="p">)</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">logs_to_delete</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">entry</span><span class="p">)</span>

        <span class="k">def</span><span class="w"> </span><span class="nf">_filenames</span><span class="p">(</span><span class="n">entries</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="n">Dict</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]:</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">e</span><span class="p">[</span><span class="s2">&quot;filename&quot;</span><span class="p">]</span> <span class="k">for</span> <span class="n">e</span> <span class="ow">in</span> <span class="n">entries</span><span class="p">]</span>

        <span class="c1"># helper to get store paths per log using rxp_inspect</span>
        <span class="k">def</span><span class="w"> </span><span class="nf">get_paths_from_logs</span><span class="p">(</span><span class="n">filenames</span><span class="p">:</span> <span class="n">Sequence</span><span class="p">[</span><span class="nb">str</span><span class="p">])</span> <span class="o">-&gt;</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]:</span>
            <span class="n">out</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]]</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">for</span> <span class="n">fn</span> <span class="ow">in</span> <span class="n">filenames</span><span class="p">:</span>
                <span class="n">wl</span> <span class="o">=</span> <span class="n">_extract_which_log</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">wl</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Could not parse which_log from filename: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">fn</span><span class="p">)</span>
                    <span class="n">out</span><span class="p">[</span><span class="n">fn</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">continue</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">insp_rows</span> <span class="o">=</span> <span class="n">rxp_inspect</span><span class="p">(</span><span class="n">project_path</span><span class="o">=</span><span class="n">project_path</span><span class="p">,</span> <span class="n">which_log</span><span class="o">=</span><span class="n">wl</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;rxp_inspect failed for </span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">fn</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
                    <span class="n">out</span><span class="p">[</span><span class="n">fn</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">continue</span>
                <span class="c1"># rxp_inspect returns list of dicts; look for &#39;path&#39; keys</span>
                <span class="n">paths</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">insp_rows</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">row</span> <span class="ow">in</span> <span class="n">insp_rows</span><span class="p">:</span>
                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">row</span><span class="p">,</span> <span class="nb">dict</span><span class="p">)</span> <span class="ow">and</span> <span class="s2">&quot;path&quot;</span> <span class="ow">in</span> <span class="n">row</span> <span class="ow">and</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;path&quot;</span><span class="p">],</span> <span class="nb">str</span><span class="p">):</span>
                            <span class="n">paths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">row</span><span class="p">[</span><span class="s2">&quot;path&quot;</span><span class="p">])</span>
                <span class="n">out</span><span class="p">[</span><span class="n">fn</span><span class="p">]</span> <span class="o">=</span> <span class="n">_validate_store_paths</span><span class="p">(</span><span class="n">paths</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">out</span>

        <span class="n">keep_paths_by_log</span> <span class="o">=</span> <span class="n">get_paths_from_logs</span><span class="p">(</span><span class="n">_filenames</span><span class="p">(</span><span class="n">logs_to_keep</span><span class="p">))</span> <span class="k">if</span> <span class="n">logs_to_keep</span> <span class="k">else</span> <span class="p">{}</span>
        <span class="n">delete_paths_by_log</span> <span class="o">=</span> <span class="n">get_paths_from_logs</span><span class="p">(</span><span class="n">_filenames</span><span class="p">(</span><span class="n">logs_to_delete</span><span class="p">))</span> <span class="k">if</span> <span class="n">logs_to_delete</span> <span class="k">else</span> <span class="p">{}</span>

        <span class="n">keep_paths_all</span> <span class="o">=</span> <span class="n">_validate_store_paths</span><span class="p">(</span><span class="nb">sorted</span><span class="p">({</span><span class="n">p</span> <span class="k">for</span> <span class="n">lst</span> <span class="ow">in</span> <span class="n">keep_paths_by_log</span><span class="o">.</span><span class="n">values</span><span class="p">()</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">lst</span><span class="p">}))</span>
        <span class="n">delete_paths_all</span> <span class="o">=</span> <span class="n">_validate_store_paths</span><span class="p">(</span><span class="nb">sorted</span><span class="p">({</span><span class="n">p</span> <span class="k">for</span> <span class="n">lst</span> <span class="ow">in</span> <span class="n">delete_paths_by_log</span><span class="o">.</span><span class="n">values</span><span class="p">()</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">lst</span><span class="p">}))</span>

        <span class="n">summary_info</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">object</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span>
            <span class="s2">&quot;kept&quot;</span><span class="p">:</span> <span class="n">_filenames</span><span class="p">(</span><span class="n">logs_to_keep</span><span class="p">),</span>
            <span class="s2">&quot;deleted&quot;</span><span class="p">:</span> <span class="n">_filenames</span><span class="p">(</span><span class="n">logs_to_delete</span><span class="p">),</span>
            <span class="s2">&quot;protected&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s2">&quot;deleted_count&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s2">&quot;failed_count&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s2">&quot;referenced_count&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s2">&quot;log_files_deleted&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s2">&quot;log_files_failed&quot;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span>
            <span class="s2">&quot;dry_run_details&quot;</span><span class="p">:</span> <span class="kc">None</span><span class="p">,</span>
        <span class="p">}</span>

        <span class="c1"># DRY RUN branch (date-based)</span>
        <span class="k">if</span> <span class="n">keep_date</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">dry_run</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;--- DRY RUN --- No changes will be made. ---&quot;</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Logs that would be deleted (</span><span class="si">%d</span><span class="s2">):&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">logs_to_delete</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">fn</span> <span class="ow">in</span> <span class="n">summary_info</span><span class="p">[</span><span class="s2">&quot;deleted&quot;</span><span class="p">]:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;  </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">fn</span><span class="p">)</span>
            <span class="n">details</span><span class="p">:</span> <span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">List</span><span class="p">[</span><span class="n">Dict</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="nb">str</span><span class="p">]]]</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="k">if</span> <span class="n">delete_paths_by_log</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Artifacts per log (from rxp_inspect):&quot;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">fn</span><span class="p">,</span> <span class="n">_</span> <span class="ow">in</span> <span class="n">delete_paths_by_log</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;== </span><span class="si">%s</span><span class="s2"> ==&quot;</span><span class="p">,</span> <span class="n">fn</span><span class="p">)</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">insp_rows</span> <span class="o">=</span> <span class="n">rxp_inspect</span><span class="p">(</span><span class="n">project_path</span><span class="o">=</span><span class="n">project_path</span><span class="p">,</span> <span class="n">which_log</span><span class="o">=</span><span class="n">_extract_which_log</span><span class="p">(</span><span class="n">fn</span><span class="p">)</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;  (rxp_inspect unavailable)&quot;</span><span class="p">)</span>
                        <span class="n">details</span><span class="p">[</span><span class="n">fn</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                        <span class="k">continue</span>
                    <span class="n">rows</span> <span class="o">=</span> <span class="p">[]</span>
                    <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">insp_rows</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
                        <span class="k">for</span> <span class="n">r</span> <span class="ow">in</span> <span class="n">insp_rows</span><span class="p">:</span>
                            <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">r</span><span class="p">,</span> <span class="nb">dict</span><span class="p">):</span>
                                <span class="k">continue</span>
                            <span class="n">rows</span><span class="o">.</span><span class="n">append</span><span class="p">({</span><span class="s2">&quot;path&quot;</span><span class="p">:</span> <span class="n">r</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;path&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">),</span> <span class="s2">&quot;output&quot;</span><span class="p">:</span> <span class="n">r</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;output&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)})</span>
                    <span class="n">details</span><span class="p">[</span><span class="n">fn</span><span class="p">]</span> <span class="o">=</span> <span class="n">rows</span>
            <span class="n">existing_delete_paths</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">delete_paths_all</span> <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="ow">or</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">p</span><span class="p">)]</span>
            <span class="n">missing_paths</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">delete_paths_all</span> <span class="k">if</span> <span class="n">p</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">existing_delete_paths</span><span class="p">]</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Aggregate store paths targeted for deletion (deduped): </span><span class="si">%d</span><span class="s2"> total, </span><span class="si">%d</span><span class="s2"> existing, </span><span class="si">%d</span><span class="s2"> missing&quot;</span><span class="p">,</span>
                        <span class="nb">len</span><span class="p">(</span><span class="n">delete_paths_all</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">existing_delete_paths</span><span class="p">),</span> <span class="nb">len</span><span class="p">(</span><span class="n">missing_paths</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">existing_delete_paths</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Existing paths that would be deleted:&quot;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">existing_delete_paths</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;  </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">missing_paths</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Paths already missing (will be skipped):&quot;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">missing_paths</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;  </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
            <span class="n">summary_info</span><span class="p">[</span><span class="s2">&quot;dry_run_details&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">details</span>
            <span class="k">if</span> <span class="n">logs_to_delete</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Build log files that would be deleted:&quot;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">fn</span> <span class="ow">in</span> <span class="n">summary_info</span><span class="p">[</span><span class="s2">&quot;deleted&quot;</span><span class="p">]:</span>
                    <span class="n">log_path</span> <span class="o">=</span> <span class="n">project_path</span> <span class="o">/</span> <span class="s2">&quot;_rixpress&quot;</span> <span class="o">/</span> <span class="n">fn</span>
                    <span class="n">exists_indicator</span> <span class="o">=</span> <span class="s2">&quot;[OK]&quot;</span> <span class="k">if</span> <span class="n">log_path</span><span class="o">.</span><span class="n">exists</span><span class="p">()</span> <span class="k">else</span> <span class="s2">&quot;[X]&quot;</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;  </span><span class="si">%s</span><span class="s2"> </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">exists_indicator</span><span class="p">,</span> <span class="n">fn</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">pretty</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">as_json</span><span class="p">:</span>
                    <span class="nb">print</span><span class="p">(</span><span class="n">json</span><span class="o">.</span><span class="n">dumps</span><span class="p">(</span><span class="n">summary_info</span><span class="p">,</span> <span class="n">indent</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">ensure_ascii</span><span class="o">=</span><span class="kc">False</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">pprint</span><span class="p">(</span><span class="n">summary_info</span><span class="p">)</span>
                <span class="k">return</span>

            <span class="k">return</span> <span class="n">summary_info</span>

        <span class="c1"># dry-run full GC preview</span>
        <span class="k">if</span> <span class="n">keep_date</span> <span class="ow">is</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">dry_run</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;--- DRY RUN --- Would run &#39;nix-store --gc&#39; (delete all unreferenced store paths). ---&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;(Tip: for an approximate preview, run &#39;nix-collect-garbage -n&#39; from a shell.)&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">summary_info</span>

        <span class="c1"># Full GC mode</span>
        <span class="k">if</span> <span class="n">keep_date</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">ask</span><span class="p">:</span>
                <span class="n">proceed</span> <span class="o">=</span> <span class="n">_ask_yes_no</span><span class="p">(</span><span class="s2">&quot;Run full Nix garbage collection (delete all unreferenced artifacts)?&quot;</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="n">proceed</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Operation cancelled.&quot;</span><span class="p">)</span>
                    <span class="k">return</span> <span class="n">summary_info</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Running Nix garbage collector...&quot;</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">_</span><span class="p">,</span> <span class="n">stdout</span><span class="p">,</span> <span class="n">stderr</span> <span class="o">=</span> <span class="n">_safe_run</span><span class="p">([</span><span class="n">nix_bin</span><span class="p">,</span> <span class="s2">&quot;--gc&quot;</span><span class="p">],</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout_sec</span><span class="p">,</span> <span class="n">check</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">stdout</span><span class="p">:</span>
                    <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">stdout</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">rel</span> <span class="o">=</span> <span class="p">[</span><span class="n">l</span> <span class="k">for</span> <span class="n">l</span> <span class="ow">in</span> <span class="n">stdout</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span> <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;freed|removing|deleting&quot;</span><span class="p">,</span> <span class="n">l</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">)]</span>
                        <span class="k">if</span> <span class="n">rel</span><span class="p">:</span>
                            <span class="k">for</span> <span class="n">line</span> <span class="ow">in</span> <span class="n">rel</span><span class="p">[</span><span class="o">-</span><span class="mi">10</span><span class="p">:]:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="n">line</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Garbage collection complete.&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">summary_info</span>
            <span class="k">except</span> <span class="n">RxpGCError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                <span class="k">raise</span>

        <span class="c1"># Targeted deletion mode</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">logs_to_delete</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;No build logs older than </span><span class="si">%s</span><span class="s2"> found. Nothing to do.&quot;</span><span class="p">,</span> <span class="n">keep_date</span><span class="o">.</span><span class="n">isoformat</span><span class="p">())</span>
            <span class="k">return</span> <span class="n">summary_info</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">delete_paths_all</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;No valid store paths found in logs older than </span><span class="si">%s</span><span class="s2">. Nothing to delete.&quot;</span><span class="p">,</span> <span class="n">keep_date</span><span class="o">.</span><span class="n">isoformat</span><span class="p">())</span>
            <span class="k">return</span> <span class="n">summary_info</span>

        <span class="n">prompt</span> <span class="o">=</span> <span class="sa">f</span><span class="s2">&quot;This will permanently delete </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">delete_paths_all</span><span class="p">)</span><span class="si">}</span><span class="s2"> store paths from </span><span class="si">{</span><span class="nb">len</span><span class="p">(</span><span class="n">logs_to_delete</span><span class="p">)</span><span class="si">}</span><span class="s2"> build(s) older than </span><span class="si">{</span><span class="n">keep_date</span><span class="o">.</span><span class="n">isoformat</span><span class="p">()</span><span class="si">}</span><span class="s2">. Continue?&quot;</span>
        <span class="k">if</span> <span class="n">ask</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">_ask_yes_no</span><span class="p">(</span><span class="n">prompt</span><span class="p">,</span> <span class="n">default</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Operation cancelled.&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">summary_info</span>

        <span class="c1"># Protect recent artifacts (date-based mode only) by adding indirect GC roots.</span>
        <span class="n">temp_gcroots_dir</span><span class="p">:</span> <span class="n">Optional</span><span class="p">[</span><span class="n">Path</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
        <span class="n">protected</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">keep_paths_all</span><span class="p">:</span>
                <span class="n">temp_gcroots_dir</span> <span class="o">=</span> <span class="n">Path</span><span class="p">(</span><span class="n">tempfile</span><span class="o">.</span><span class="n">mkdtemp</span><span class="p">(</span><span class="n">prefix</span><span class="o">=</span><span class="s2">&quot;rixpress-gc-&quot;</span><span class="p">))</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Protecting </span><span class="si">%d</span><span class="s2"> recent artifacts via GC roots...&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">keep_paths_all</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">p</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">keep_paths_all</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
                    <span class="n">link_path</span> <span class="o">=</span> <span class="n">temp_gcroots_dir</span> <span class="o">/</span> <span class="sa">f</span><span class="s2">&quot;root-</span><span class="si">{</span><span class="n">i</span><span class="si">}</span><span class="s2">&quot;</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="c1"># create a placeholder link path (the nix-store --add-root will create the gcroot)</span>
                        <span class="c1"># use link_path as the path to register the indirect root</span>
                        <span class="n">_safe_run</span><span class="p">([</span><span class="n">nix_bin</span><span class="p">,</span> <span class="s2">&quot;--add-root&quot;</span><span class="p">,</span> <span class="nb">str</span><span class="p">(</span><span class="n">link_path</span><span class="p">),</span> <span class="s2">&quot;--indirect&quot;</span><span class="p">,</span> <span class="n">p</span><span class="p">],</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout_sec</span><span class="p">,</span> <span class="n">check</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
                        <span class="n">created_gcroot_links</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">link_path</span><span class="p">)</span>
                        <span class="n">protected</span> <span class="o">+=</span> <span class="mi">1</span>
                    <span class="k">except</span> <span class="n">RxpGCError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">warning</span><span class="p">(</span><span class="s2">&quot;Failed to add GC root for </span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">p</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
                <span class="k">if</span> <span class="n">protected</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="n">RxpGCError</span><span class="p">(</span><span class="s2">&quot;Failed to protect any store paths. Aborting.&quot;</span><span class="p">)</span>
                <span class="n">summary_info</span><span class="p">[</span><span class="s2">&quot;protected&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">protected</span>

            <span class="c1"># Delete specific store paths</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Deleting </span><span class="si">%d</span><span class="s2"> targeted store paths...&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">delete_paths_all</span><span class="p">))</span>
            <span class="n">existing_paths</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">delete_paths_all</span> <span class="k">if</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">p</span><span class="p">)</span> <span class="ow">or</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">p</span><span class="p">)]</span>
            <span class="n">missing_paths</span> <span class="o">=</span> <span class="p">[</span><span class="n">p</span> <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">delete_paths_all</span> <span class="k">if</span> <span class="n">p</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">existing_paths</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">missing_paths</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;Skipping </span><span class="si">%d</span><span class="s2"> paths that no longer exist.&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">missing_paths</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">missing_paths</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;  Missing: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">existing_paths</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;No existing paths to delete. All targeted paths are already gone.&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">summary_info</span>

            <span class="n">total_deleted</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">failed_paths</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="n">referenced_paths</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>

            <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">pth</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">existing_paths</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">exists</span><span class="p">(</span><span class="n">pth</span><span class="p">)</span> <span class="ow">or</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="n">pth</span><span class="p">)):</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;  [</span><span class="si">%d</span><span class="s2">/</span><span class="si">%d</span><span class="s2">] Skipping </span><span class="si">%s</span><span class="s2"> (already gone)&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">existing_paths</span><span class="p">),</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">pth</span><span class="p">))</span>
                    <span class="k">continue</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;  [</span><span class="si">%d</span><span class="s2">/</span><span class="si">%d</span><span class="s2">] Attempting to delete </span><span class="si">%s</span><span class="s2">...&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">existing_paths</span><span class="p">),</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">pth</span><span class="p">))</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">proc</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">run</span><span class="p">([</span><span class="n">nix_bin</span><span class="p">,</span> <span class="s2">&quot;--delete&quot;</span><span class="p">,</span> <span class="n">pth</span><span class="p">],</span> <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">text</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout_sec</span><span class="p">)</span>
                    <span class="n">out</span> <span class="o">=</span> <span class="p">(</span><span class="n">proc</span><span class="o">.</span><span class="n">stdout</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="p">(</span><span class="n">proc</span><span class="o">.</span><span class="n">stderr</span> <span class="ow">or</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
                    <span class="k">if</span> <span class="n">proc</span><span class="o">.</span><span class="n">returncode</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="n">total_deleted</span> <span class="o">+=</span> <span class="mi">1</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;    [OK] Successfully deleted&quot;</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">verbose</span> <span class="ow">and</span> <span class="n">out</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;    </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">out</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">re</span><span class="o">.</span><span class="n">search</span><span class="p">(</span><span class="sa">r</span><span class="s2">&quot;still alive|Cannot delete&quot;</span><span class="p">,</span> <span class="n">out</span><span class="p">,</span> <span class="n">re</span><span class="o">.</span><span class="n">I</span><span class="p">):</span>
                            <span class="n">referenced_paths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pth</span><span class="p">)</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;    [!] Skipped (still referenced)&quot;</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;    Details: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">out</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">failed_paths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pth</span><span class="p">)</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;    [X] Failed to delete&quot;</span><span class="p">)</span>
                            <span class="k">if</span> <span class="n">verbose</span><span class="p">:</span>
                                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;    Details: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">out</span><span class="o">.</span><span class="n">strip</span><span class="p">())</span>
                <span class="k">except</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">TimeoutExpired</span><span class="p">:</span>
                    <span class="n">failed_paths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pth</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;    [X] Timeout while deleting&quot;</span><span class="p">)</span>
                <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                    <span class="n">failed_paths</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">pth</span><span class="p">)</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;    [X] Error: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>

            <span class="c1"># Summary of deletion</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Deletion summary:&quot;</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;  Successfully deleted: </span><span class="si">%d</span><span class="s2"> paths&quot;</span><span class="p">,</span> <span class="n">total_deleted</span><span class="p">)</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;  Skipped (still referenced): </span><span class="si">%d</span><span class="s2"> paths&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">referenced_paths</span><span class="p">))</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;  Failed (other errors): </span><span class="si">%d</span><span class="s2"> paths&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">failed_paths</span><span class="p">))</span>

            <span class="k">if</span> <span class="n">referenced_paths</span> <span class="ow">and</span> <span class="n">verbose</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Referenced paths (cannot delete):&quot;</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">pth</span> <span class="ow">in</span> <span class="n">referenced_paths</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;  </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">pth</span><span class="p">))</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">_</span><span class="p">,</span> <span class="n">roots_out</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">_safe_run</span><span class="p">([</span><span class="n">nix_bin</span><span class="p">,</span> <span class="s2">&quot;--query&quot;</span><span class="p">,</span> <span class="s2">&quot;--roots&quot;</span><span class="p">,</span> <span class="n">pth</span><span class="p">],</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout_sec</span><span class="p">,</span> <span class="n">check</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">roots_out</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;    GC roots: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">roots_out</span><span class="o">.</span><span class="n">strip</span><span class="p">()</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;, &quot;</span><span class="p">))</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;    GC roots: (none found)&quot;</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;    GC roots: (query failed)&quot;</span><span class="p">)</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">_</span><span class="p">,</span> <span class="n">refs_out</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">_safe_run</span><span class="p">([</span><span class="n">nix_bin</span><span class="p">,</span> <span class="s2">&quot;--query&quot;</span><span class="p">,</span> <span class="s2">&quot;--referrers&quot;</span><span class="p">,</span> <span class="n">pth</span><span class="p">],</span> <span class="n">timeout</span><span class="o">=</span><span class="n">timeout_sec</span><span class="p">,</span> <span class="n">check</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
                        <span class="k">if</span> <span class="n">refs_out</span><span class="o">.</span><span class="n">strip</span><span class="p">():</span>
                            <span class="n">refs</span> <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">x</span><span class="p">)</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">refs_out</span><span class="o">.</span><span class="n">splitlines</span><span class="p">()</span> <span class="k">if</span> <span class="n">x</span><span class="o">.</span><span class="n">strip</span><span class="p">()]</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;    Referenced by: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="s2">&quot;, &quot;</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">refs</span><span class="p">)</span> <span class="k">if</span> <span class="n">refs</span> <span class="k">else</span> <span class="s2">&quot;(none)&quot;</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;    Referenced by: (none)&quot;</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;    Referenced by: (query failed)&quot;</span><span class="p">)</span>

            <span class="n">summary_info</span><span class="p">[</span><span class="s2">&quot;deleted_count&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">total_deleted</span>
            <span class="n">summary_info</span><span class="p">[</span><span class="s2">&quot;failed_count&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">failed_paths</span><span class="p">)</span>
            <span class="n">summary_info</span><span class="p">[</span><span class="s2">&quot;referenced_count&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">referenced_paths</span><span class="p">)</span>

            <span class="c1"># Delete old build log files</span>
            <span class="k">if</span> <span class="n">logs_to_delete</span><span class="p">:</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Deleting old build log files...&quot;</span><span class="p">)</span>
                <span class="n">log_files_deleted</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">log_files_failed</span><span class="p">:</span> <span class="n">List</span><span class="p">[</span><span class="nb">str</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">entry</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">logs_to_delete</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
                    <span class="n">log_file</span> <span class="o">=</span> <span class="n">entry</span><span class="p">[</span><span class="s2">&quot;filename&quot;</span><span class="p">]</span>
                    <span class="n">log_path</span> <span class="o">=</span> <span class="n">project_path</span> <span class="o">/</span> <span class="s2">&quot;_rixpress&quot;</span> <span class="o">/</span> <span class="n">log_file</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;  [</span><span class="si">%d</span><span class="s2">/</span><span class="si">%d</span><span class="s2">] Deleting </span><span class="si">%s</span><span class="s2">...&quot;</span><span class="p">,</span> <span class="n">i</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">logs_to_delete</span><span class="p">),</span> <span class="n">log_file</span><span class="p">)</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="n">log_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;    [!] File not found (already deleted?)&quot;</span><span class="p">)</span>
                        <span class="k">continue</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">log_path</span><span class="o">.</span><span class="n">unlink</span><span class="p">()</span>
                        <span class="k">if</span> <span class="ow">not</span> <span class="n">log_path</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                            <span class="n">log_files_deleted</span> <span class="o">+=</span> <span class="mi">1</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;    [OK] Successfully deleted&quot;</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">log_files_failed</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">log_file</span><span class="p">)</span>
                            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;    [X] Failed to delete (file still exists)&quot;</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
                        <span class="n">log_files_failed</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">log_file</span><span class="p">)</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;    [X] Error: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Build log deletion summary:&quot;</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;  Successfully deleted: </span><span class="si">%d</span><span class="s2"> files&quot;</span><span class="p">,</span> <span class="n">log_files_deleted</span><span class="p">)</span>
                <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;  Failed: </span><span class="si">%d</span><span class="s2"> files&quot;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">log_files_failed</span><span class="p">))</span>
                <span class="k">if</span> <span class="n">log_files_failed</span> <span class="ow">and</span> <span class="n">verbose</span><span class="p">:</span>
                    <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Failed to delete log files:&quot;</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">lf</span> <span class="ow">in</span> <span class="n">log_files_failed</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;  </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">lf</span><span class="p">)</span>
                <span class="n">summary_info</span><span class="p">[</span><span class="s2">&quot;log_files_deleted&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="n">log_files_deleted</span>
                <span class="n">summary_info</span><span class="p">[</span><span class="s2">&quot;log_files_failed&quot;</span><span class="p">]</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">log_files_failed</span><span class="p">)</span>

            <span class="n">logger</span><span class="o">.</span><span class="n">info</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\n</span><span class="s2">Cleanup complete!&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">summary_info</span>
        <span class="k">finally</span><span class="p">:</span>
            <span class="c1"># Always attempt to remove created gcroot links and the temp dir</span>
            <span class="k">if</span> <span class="n">created_gcroot_links</span><span class="p">:</span>
                <span class="k">for</span> <span class="n">p</span> <span class="ow">in</span> <span class="n">created_gcroot_links</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">p</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                            <span class="n">p</span><span class="o">.</span><span class="n">unlink</span><span class="p">()</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Failed to unlink gcroot link </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">p</span><span class="p">)</span>
                <span class="c1"># attempt to remove the parent temp directory if exists and empty</span>
                <span class="k">if</span> <span class="n">temp_gcroots_dir</span> <span class="ow">and</span> <span class="n">temp_gcroots_dir</span><span class="o">.</span><span class="n">exists</span><span class="p">():</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">shutil</span><span class="o">.</span><span class="n">rmtree</span><span class="p">(</span><span class="n">temp_gcroots_dir</span><span class="p">)</span>
                    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
                        <span class="c1"># ignore: best-effort cleanup</span>
                        <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Failed to remove temp gcroots dir </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">temp_gcroots_dir</span><span class="p">)</span>
    <span class="k">finally</span><span class="p">:</span>
        <span class="c1"># always release lock and restore signals</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">lock_path_context</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">lock_path_context</span><span class="o">.</span><span class="n">release</span><span class="p">()</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">pass</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">signal</span><span class="o">.</span><span class="n">signal</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGINT</span><span class="p">,</span> <span class="n">old_sigint</span><span class="p">)</span>
            <span class="n">signal</span><span class="o">.</span><span class="n">signal</span><span class="p">(</span><span class="n">signal</span><span class="o">.</span><span class="n">SIGTERM</span><span class="p">,</span> <span class="n">old_sigterm</span><span class="p">)</span>
        <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
            <span class="k">pass</span>
</code></pre></div></td></tr></table></div>
            </details>
    </div>

</div>







  
    
  
  


  <aside class="md-source-file">
    
      
  <span class="md-source-file__fact">
    <span class="md-icon" title="Last update">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M21 13.1c-.1 0-.3.1-.4.2l-1 1 2.1 2.1 1-1c.2-.2.2-.6 0-.8l-1.3-1.3c-.1-.1-.2-.2-.4-.2m-1.9 1.8-6.1 6V23h2.1l6.1-6.1zM12.5 7v5.2l4 2.4-1 1L11 13V7zM11 21.9c-5.1-.5-9-4.8-9-9.9C2 6.5 6.5 2 12 2c5.3 0 9.6 4.1 10 9.3-.3-.1-.6-.2-1-.2s-.7.1-1 .2C19.6 7.2 16.2 4 12 4c-4.4 0-8 3.6-8 8 0 4.1 3.1 7.5 7.1 7.9l-.1.2z"/></svg>
    </span>
    <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-date" title="January 22, 2026 14:49:28 UTC">January 22, 2026</span>
  </span>

    
    
    
    
  </aside>





                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
        <div class="md-social">
  
    
    
    
    
      
      
    
    <a href="https://github.com/b-rodrigues/ryxpress" target="_blank" rel="noopener" title="github.com" class="md-social__link">
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 7.0.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2025 Fonticons, Inc.--><path fill="currentColor" d="M173.9 397.4c0 2-2.3 3.6-5.2 3.6-3.3.3-5.6-1.3-5.6-3.6 0-2 2.3-3.6 5.2-3.6 3-.3 5.6 1.3 5.6 3.6m-31.1-4.5c-.7 2 1.3 4.3 4.3 4.9 2.6 1 5.6 0 6.2-2s-1.3-4.3-4.3-5.2c-2.6-.7-5.5.3-6.2 2.3m44.2-1.7c-2.9.7-4.9 2.6-4.6 4.9.3 2 2.9 3.3 5.9 2.6 2.9-.7 4.9-2.6 4.6-4.6-.3-1.9-3-3.2-5.9-2.9M252.8 8C114.1 8 8 113.3 8 252c0 110.9 69.8 205.8 169.5 239.2 12.8 2.3 17.3-5.6 17.3-12.1 0-6.2-.3-40.4-.3-61.4 0 0-70 15-84.7-29.8 0 0-11.4-29.1-27.8-36.6 0 0-22.9-15.7 1.6-15.4 0 0 24.9 2 38.6 25.8 21.9 38.6 58.6 27.5 72.9 20.9 2.3-16 8.8-27.1 16-33.7-55.9-6.2-112.3-14.3-112.3-110.5 0-27.5 7.6-41.3 23.6-58.9-2.6-6.5-11.1-33.3 2.6-67.9 20.9-6.5 69 27 69 27 20-5.6 41.5-8.5 62.8-8.5s42.8 2.9 62.8 8.5c0 0 48.1-33.6 69-27 13.7 34.7 5.2 61.4 2.6 67.9 16 17.7 25.8 31.5 25.8 58.9 0 96.5-58.9 104.2-114.8 110.5 9.2 7.9 17 22.9 17 46.4 0 33.7-.3 75.4-.3 83.6 0 6.5 4.6 14.4 17.3 12.1C436.2 457.8 504 362.9 504 252 504 113.3 391.5 8 252.8 8M105.2 352.9c-1.3 1-1 3.3.7 5.2 1.6 1.6 3.9 2.3 5.2 1 1.3-1 1-3.3-.7-5.2-1.6-1.6-3.9-2.3-5.2-1m-10.8-8.1c-.7 1.3.3 2.9 2.3 3.9 1.6 1 3.6.7 4.3-.7.7-1.3-.3-2.9-2.3-3.9-2-.6-3.6-.3-4.3.7m32.4 35.6c-1.6 1.3-1 4.3 1.3 6.2 2.3 2.3 5.2 2.6 6.5 1 1.3-1.3.7-4.3-1.3-6.2-2.2-2.3-5.2-2.6-6.5-1m-11.4-14.7c-1.6 1-1.6 3.6 0 5.9s4.3 3.3 5.6 2.3c1.6-1.3 1.6-3.9 0-6.2-1.4-2.3-4-3.3-5.6-2"/></svg>
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "..", "features": ["navigation.instant", "navigation.tabs"], "search": "../assets/javascripts/workers/search.d50fe291.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../assets/javascripts/bundle.50899def.min.js"></script>
      
    
  </body>
</html>